/*! For license information please see index.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("cornerstoneRender"),require("gl-matrix"),require("vtk.js/Sources/Common/Core/Math"),require("vtk.js/Sources/Common/Core/MatrixBuilder"),require("cornerstoneImageLoaderStreamingVolume")):"function"==typeof define&&define.amd?define(["cornerstoneRender","gl-matrix","vtk.js/Sources/Common/Core/Math","vtk.js/Sources/Common/Core/MatrixBuilder","cornerstoneImageLoaderStreamingVolume"],t):"object"==typeof exports?exports.cornerstoneTools=t(require("cornerstoneRender"),require("gl-matrix"),require("vtk.js/Sources/Common/Core/Math"),require("vtk.js/Sources/Common/Core/MatrixBuilder"),require("cornerstoneImageLoaderStreamingVolume")):e.cornerstoneTools=t(e.window,e.window,e["vtk.js/Sources/Common/Core/Math"],e["vtk.js/Sources/Common/Core/MatrixBuilder"],e.window)}(this,(function(e,t,n,a,o){return function(){var r={907:function(e,t,n){e=n.nmd(e);var a="__lodash_hash_undefined__",o=9007199254740991,r="[object Arguments]",i="[object Boolean]",l="[object Date]",c="[object Function]",s="[object GeneratorFunction]",d="[object Map]",u="[object Number]",v="[object Object]",f="[object Promise]",h="[object RegExp]",g="[object Set]",m="[object String]",p="[object Symbol]",b="[object WeakMap]",w="[object ArrayBuffer]",E="[object DataView]",_="[object Float32Array]",D="[object Float64Array]",y="[object Int8Array]",C="[object Int16Array]",T="[object Int32Array]",U="[object Uint8Array]",I="[object Uint8ClampedArray]",S="[object Uint16Array]",M="[object Uint32Array]",k=/\w*$/,x=/^\[object .+?Constructor\]$/,O=/^(?:0|[1-9]\d*)$/,L={};L[r]=L["[object Array]"]=L[w]=L[E]=L[i]=L[l]=L[_]=L[D]=L[y]=L[C]=L[T]=L[d]=L[u]=L[v]=L[h]=L[g]=L[m]=L[p]=L[U]=L[I]=L[S]=L[M]=!0,L["[object Error]"]=L[c]=L[b]=!1;var R="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,A="object"==typeof self&&self&&self.Object===Object&&self,P=R||A||Function("return this")(),V=t&&!t.nodeType&&t,N=V&&e&&!e.nodeType&&e,B=N&&N.exports===V;function H(e,t){return e.set(t[0],t[1]),e}function j(e,t){return e.add(t),e}function F(e,t,n,a){var o=-1,r=e?e.length:0;for(a&&r&&(n=e[++o]);++o<r;)n=t(n,e[o],o,e);return n}function W(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function G(e){var t=-1,n=Array(e.size);return e.forEach((function(e,a){n[++t]=[a,e]})),n}function z(e,t){return function(n){return e(t(n))}}function q(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var K,Y=Array.prototype,X=Function.prototype,$=Object.prototype,J=P["__core-js_shared__"],Z=(K=/[^.]+$/.exec(J&&J.keys&&J.keys.IE_PROTO||""))?"Symbol(src)_1."+K:"",Q=X.toString,ee=$.hasOwnProperty,te=$.toString,ne=RegExp("^"+Q.call(ee).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),ae=B?P.Buffer:void 0,oe=P.Symbol,re=P.Uint8Array,ie=z(Object.getPrototypeOf,Object),le=Object.create,ce=$.propertyIsEnumerable,se=Y.splice,de=Object.getOwnPropertySymbols,ue=ae?ae.isBuffer:void 0,ve=z(Object.keys,Object),fe=Pe(P,"DataView"),he=Pe(P,"Map"),ge=Pe(P,"Promise"),me=Pe(P,"Set"),pe=Pe(P,"WeakMap"),be=Pe(Object,"create"),we=je(fe),Ee=je(he),_e=je(ge),De=je(me),ye=je(pe),Ce=oe?oe.prototype:void 0,Te=Ce?Ce.valueOf:void 0;function Ue(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var a=e[t];this.set(a[0],a[1])}}function Ie(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var a=e[t];this.set(a[0],a[1])}}function Se(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var a=e[t];this.set(a[0],a[1])}}function Me(e){this.__data__=new Ie(e)}function ke(e,t,n){var a=e[t];ee.call(e,t)&&Fe(a,n)&&(void 0!==n||t in e)||(e[t]=n)}function xe(e,t){for(var n=e.length;n--;)if(Fe(e[n][0],t))return n;return-1}function Oe(e,t,n,a,o,f,b){var x;if(a&&(x=f?a(e,o,f,b):a(e)),void 0!==x)return x;if(!Ke(e))return e;var O=We(e);if(O){if(x=function(e){var t=e.length,n=e.constructor(t);return t&&"string"==typeof e[0]&&ee.call(e,"index")&&(n.index=e.index,n.input=e.input),n}(e),!t)return function(e,t){var n=-1,a=e.length;for(t||(t=Array(a));++n<a;)t[n]=e[n];return t}(e,x)}else{var R=Ne(e),A=R==c||R==s;if(ze(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if(R==v||R==r||A&&!f){if(W(e))return f?e:{};if(x=function(e){return"function"!=typeof e.constructor||He(e)?{}:Ke(t=ie(e))?le(t):{};var t}(A?{}:e),!t)return function(e,t){return Re(e,Ve(e),t)}(e,function(e,t){return e&&Re(t,Ye(t),e)}(x,e))}else{if(!L[R])return f?e:{};x=function(e,t,n,a){var o,r=e.constructor;switch(t){case w:return Le(e);case i:case l:return new r(+e);case E:return function(e,t){var n=t?Le(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,a);case _:case D:case y:case C:case T:case U:case I:case S:case M:return function(e,t){var n=t?Le(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}(e,a);case d:return function(e,t,n){return F(t?n(G(e),!0):G(e),H,new e.constructor)}(e,a,n);case u:case m:return new r(e);case h:return function(e){var t=new e.constructor(e.source,k.exec(e));return t.lastIndex=e.lastIndex,t}(e);case g:return function(e,t,n){return F(t?n(q(e),!0):q(e),j,new e.constructor)}(e,a,n);case p:return o=e,Te?Object(Te.call(o)):{}}}(e,R,Oe,t)}}b||(b=new Me);var P=b.get(e);if(P)return P;if(b.set(e,x),!O)var V=n?function(e){return function(e,t,n){var a=t(e);return We(e)?a:function(e,t){for(var n=-1,a=t.length,o=e.length;++n<a;)e[o+n]=t[n];return e}(a,n(e))}(e,Ye,Ve)}(e):Ye(e);return function(e,t){for(var n=-1,a=e?e.length:0;++n<a&&!1!==t(e[n],n););}(V||e,(function(o,r){V&&(o=e[r=o]),ke(x,r,Oe(o,t,n,a,r,e,b))})),x}function Le(e){var t=new e.constructor(e.byteLength);return new re(t).set(new re(e)),t}function Re(e,t,n,a){n||(n={});for(var o=-1,r=t.length;++o<r;){var i=t[o],l=a?a(n[i],e[i],i,n,e):void 0;ke(n,i,void 0===l?e[i]:l)}return n}function Ae(e,t){var n,a,o=e.__data__;return("string"==(a=typeof(n=t))||"number"==a||"symbol"==a||"boolean"==a?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function Pe(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){return!(!Ke(e)||(t=e,Z&&Z in t))&&(qe(e)||W(e)?ne:x).test(je(e));var t}(n)?n:void 0}Ue.prototype.clear=function(){this.__data__=be?be(null):{}},Ue.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},Ue.prototype.get=function(e){var t=this.__data__;if(be){var n=t[e];return n===a?void 0:n}return ee.call(t,e)?t[e]:void 0},Ue.prototype.has=function(e){var t=this.__data__;return be?void 0!==t[e]:ee.call(t,e)},Ue.prototype.set=function(e,t){return this.__data__[e]=be&&void 0===t?a:t,this},Ie.prototype.clear=function(){this.__data__=[]},Ie.prototype.delete=function(e){var t=this.__data__,n=xe(t,e);return!(n<0||(n==t.length-1?t.pop():se.call(t,n,1),0))},Ie.prototype.get=function(e){var t=this.__data__,n=xe(t,e);return n<0?void 0:t[n][1]},Ie.prototype.has=function(e){return xe(this.__data__,e)>-1},Ie.prototype.set=function(e,t){var n=this.__data__,a=xe(n,e);return a<0?n.push([e,t]):n[a][1]=t,this},Se.prototype.clear=function(){this.__data__={hash:new Ue,map:new(he||Ie),string:new Ue}},Se.prototype.delete=function(e){return Ae(this,e).delete(e)},Se.prototype.get=function(e){return Ae(this,e).get(e)},Se.prototype.has=function(e){return Ae(this,e).has(e)},Se.prototype.set=function(e,t){return Ae(this,e).set(e,t),this},Me.prototype.clear=function(){this.__data__=new Ie},Me.prototype.delete=function(e){return this.__data__.delete(e)},Me.prototype.get=function(e){return this.__data__.get(e)},Me.prototype.has=function(e){return this.__data__.has(e)},Me.prototype.set=function(e,t){var n=this.__data__;if(n instanceof Ie){var a=n.__data__;if(!he||a.length<199)return a.push([e,t]),this;n=this.__data__=new Se(a)}return n.set(e,t),this};var Ve=de?z(de,Object):function(){return[]},Ne=function(e){return te.call(e)};function Be(e,t){return!!(t=null==t?o:t)&&("number"==typeof e||O.test(e))&&e>-1&&e%1==0&&e<t}function He(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||$)}function je(e){if(null!=e){try{return Q.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function Fe(e,t){return e===t||e!=e&&t!=t}(fe&&Ne(new fe(new ArrayBuffer(1)))!=E||he&&Ne(new he)!=d||ge&&Ne(ge.resolve())!=f||me&&Ne(new me)!=g||pe&&Ne(new pe)!=b)&&(Ne=function(e){var t=te.call(e),n=t==v?e.constructor:void 0,a=n?je(n):void 0;if(a)switch(a){case we:return E;case Ee:return d;case _e:return f;case De:return g;case ye:return b}return t});var We=Array.isArray;function Ge(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=o}(e.length)&&!qe(e)}var ze=ue||function(){return!1};function qe(e){var t=Ke(e)?te.call(e):"";return t==c||t==s}function Ke(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ye(e){return Ge(e)?function(e,t){var n=We(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ge(e)}(e)&&ee.call(e,"callee")&&(!ce.call(e,"callee")||te.call(e)==r)}(e)?function(e,t){for(var n=-1,a=Array(e);++n<e;)a[n]=t(n);return a}(e.length,String):[],a=n.length,o=!!a;for(var i in e)!t&&!ee.call(e,i)||o&&("length"==i||Be(i,a))||n.push(i);return n}(e):function(e){if(!He(e))return ve(e);var t=[];for(var n in Object(e))ee.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e)}e.exports=function(e){return Oe(e,!0,!0)}},812:function(e){"use strict";e.exports=n},653:function(e){"use strict";e.exports=a},708:function(e){"use strict";e.exports=o},45:function(t){"use strict";t.exports=e},167:function(e){"use strict";e.exports=t}},i={};function l(e){var t=i[e];if(void 0!==t)return t.exports;var n=i[e]={id:e,loaded:!1,exports:{}};return r[e](n,n.exports,l),n.loaded=!0,n.exports}l.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return l.d(t,{a:t}),t},l.d=function(e,t){for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),l.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},l.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e};var c={};return function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function n(e,n,a){return n&&t(e.prototype,n),a&&t(e,a),e}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}))}l.r(c),l.d(c,{BaseAnnotationTool:function(){return wn},BaseTool:function(){return fn},BidirectionalTool:function(){return Wn},CornerstoneTools3DEvents:function(){return X},CrosshairsTool:function(){return jn},EllipticalRoiTool:function(){return Kn},FrameOfReferenceSpecificToolStateManager:function(){return d},LengthTool:function(){return Gn},MIPJumpToClickTool:function(){return Fn},PanTool:function(){return En},PetThresholdTool:function(){return Cn},ProbeTool:function(){return zn},RectangleRoiTool:function(){return qn},StackScrollMouseWheelTool:function(){return Un},StackScrollTool:function(){return Tn},SynchronizerManager:function(){return _t},ToolBindings:function(){return Ee},ToolGroupManager:function(){return bt},VolumeRotateMouseWheelTool:function(){return Mn},WindowLevelTool:function(){return Dn},ZoomTool:function(){return In},addTool:function(){return K},addToolState:function(){return Yt},defaultFrameOfReferenceSpecificToolStateManager:function(){return u},drawing:function(){return ln},getToolState:function(){return Kt},init:function(){return Xt},resetToolsState:function(){return Y},synchronizers:function(){return vn},textStyle:function(){return g},toolColors:function(){return w},toolStyle:function(){return D}});var r=l(907),i=l.n(r),s=l(45),d=function(){function t(n){var r=this;e(this,t),a(this,"toolState",void 0),a(this,"uid",void 0),a(this,"_imageVolumeModifiedHandler",(function(e){var t=e.detail.FrameOfReferenceUID,n=r.toolState[t];n&&Object.keys(n).forEach((function(e){n[e].forEach((function(e){var t=e.data;t&&void 0!==t.invalidated&&(t.invalidated=!0)}))}))})),a(this,"get",(function(e,t){var n=r.toolState[e];if(n)return n[t]})),a(this,"getToolStateByToolUID",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r._getToolSpecificToolStateAndIndex(e,t);if(n){var a=n.toolSpecificToolState,o=n.index;return a[o]}})),a(this,"addToolState",(function(e){var t=e.metadata,n=t.FrameOfReferenceUID,a=t.toolName,o=r.toolState,i=o[n];i||(o[n]={},i=o[n]);var l=i[a];l||(i[a]=[],l=i[a]),l.push(e)})),a(this,"removeToolState",(function(e){var t=e.metadata,n=t.FrameOfReferenceUID,a=t.toolName,o=t.toolUID,i=r.toolState[n];if(!i)throw new Error("frameOfReferenceSpecificToolState with FrameOfReferenceUID ".concat(n," does not exist."));var l=i[a];if(!l)throw new Error("toolSpecificToolState for toolName ".concat(a," on FrameOfReferenceUID ").concat(n," does not exist."));var c=l.findIndex((function(e){return e.metadata.toolUID===o}));l.splice(c,1)})),a(this,"removeToolStateByToolUID",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r._getToolSpecificToolStateAndIndex(e,t);if(n){var a=n.toolSpecificToolState,o=n.index;a.splice(o,1)}})),a(this,"saveToolState",(function(e,t){var n=r.toolState;if(e&&t){var a=n[e];if(!a)return;var o=a[t];return i()(o)}if(e){var l=n[e];return i()(l)}return i()(n)})),a(this,"restoreToolState",(function(e,t,n){var a=r.toolState;if(t&&n){var o=a[t];o||(a[t]={},o=a[t]),o[n]=e}else t?a[t]=e:r.toolState=e})),n||(n=o()),this.toolState={},this.uid=n,s.eventTarget.addEventListener(s.EVENTS.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}return n(t,[{key:"_getToolSpecificToolStateAndIndex",value:function(e,t){for(var n,a=t.toolName,o=t.FrameOfReferenceUID,r=this.toolState,i=(n=o?[o]:Object.keys(r)).length,l=0;l<i;l++)for(var c,s=r[n[l]],d=(c=a?[a]:Object.keys(s)).length,u=0;u<d;u++){var v=s[c[u]],f=v.findIndex((function(t){return t.metadata.toolUID===e}));if(-1!==f)return{toolSpecificToolState:v,index:f}}}}]),t}(),u=new d("DEFAULT"),v=15,f="Arial",h="transparent",g={setFontName:function(e){f=e},getFontName:function(){return f},setFontSize:function(e){v=e},getFontSize:function(){return v},getFont:function(){return"".concat(v,"px ").concat(f)},setBackgroundColor:function(e){h=e},getBackgroundColor:function(){return h}},m="rgb(255, 255, 0)",p="rgb(0, 255, 0)",b="transparent",w={setFillColor:function(e){b=e},getFillColor:function(){return b},setToolColor:function(e){m=e},getToolColor:function(){return m},setActiveColor:function(e){p=e},getActiveColor:function(){return p},getColorIfActive:function(e){return e.color?e.color:e.active?p:m}},E=1,_=2,D={setToolWidth:function(e){E=e},getToolWidth:function(){return E},setActiveWidth:function(e){_=e},getActiveWidth:function(){return _}};function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function C(e,t){if(e){if("string"==typeof e)return y(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?y(e,t):void 0}}function T(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],a=!0,o=!1,r=void 0;try{for(var i,l=e[Symbol.iterator]();!(a=(i=l.next()).done)&&(n.push(i.value),!t||n.length!==t);a=!0);}catch(e){o=!0,r=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw r}}return n}}(e,t)||C(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function U(e){return function(e){if(Array.isArray(e))return y(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||C(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function I(e,t){var n=[0,0],a=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){var o,r,i,l,c,s,d,u=(o=e,i=(r=T(t,2))[0],l=r[1],s=(c=T(o,2))[0],d=c[1],Math.sqrt(Math.pow(i-s,2)+Math.pow(l-d,2)));u<a&&(a=u,n=U(e))})),n}var S=1e-6;function M(e,t,n){var a=T(n,2),o=a[0],r=a[1];if(Math.abs(t)<S)return e<0;var i=e/t;if(t>0){if(i>r)return 0;i>o&&(n[0]=i)}else{if(i<o)return 0;i<r&&(n[1]=i)}return 1}var k={isEqual:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return Math.abs(e[0]-t[0])<n&&Math.abs(e[1]-t[1])<n},findClosestPoint:I,liangBarksyClip:function(e,t,n,a,o){var r=T(e,2),i=r[0],l=r[1],c=T(t,2),s=c[0]-i,d=c[1]-l;if(void 0===a||void 0===o?(a=e,o=t):(a[0]=e[0],a[1]=e[1],o[0]=t[0],o[1]=t[1]),Math.abs(s)<S&&Math.abs(d)<S&&i>=n[0]&&i<=n[2]&&l>=n[1]&&l<=n[3])return 1;var u=[0,1];if(M(n[0]-i,s,u)&&M(i-n[2],-s,u)&&M(n[1]-l,d,u)&&M(l-n[3],-d,u)){var v=u[0],f=u[1];return f<1&&(o[0]=i+f*s,o[1]=l+f*d),v>0&&(a[0]+=v*s,a[1]+=v*d),1}return 0}};function x(e,t){var n=e.width/2,a=e.height/2;if(n<=0||a<=0)return!1;var o=[e.left+n,e.top+a],r=[t[0]-o[0],t[1]-o[1]];return r[0]*r[0]/(n*n)+r[1]*r[1]/(a*a)<=1}function O(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function L(e,t,n){var a=O(e,t);if(0===a)return O(n,e);var o=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/a;return O(n,o<0?e:o>1?t:[e[0]+o*(t[0]-e[0]),e[1]+o*(t[1]-e[1])])}function R(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}var A={distanceToPoint:function(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt(L(e,t,n))},distanceToPointSquared:L,intersectLine:function(e,t,n,a){var o=T(e,2),r=o[0],i=o[1],l=T(t,2),c=l[0],s=l[1],d=T(n,2),u=d[0],v=d[1],f=T(a,2),h=f[0],g=f[1],m=s-i,p=r-c,b=c*i-r*s,w=m*u+p*v+b,E=m*h+p*g+b;if(0===w||0===E||R(w)!==R(E)){var _=g-v,D=u-h,y=h*v-u*g,C=_*r+D*i+y,U=_*c+D*s+y;if(0===C||0===U||R(C)!==R(U)){var I=m*D-_*p;return[(p*y-D*b)/I,(_*b-m*y)/I]}}}},P={distanceToPoint:function(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");var n=T(e,4),a=n[0],o=n[1],r=n[2],i=n[3],l=655535,c=function(e,t,n,a){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+a]],bottom:[[e+n,t+a],[e,t+a]],left:[[e,t+a],[e,t]]}}(a,o,r,i);return Object.keys(c).forEach((function(e){var n=T(c[e],2),a=n[0],o=n[1],r=A.distanceToPoint(a,o,t);r<l&&(l=r)})),l}},V={vec2:k,vec3:{isEqual:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return Math.abs(e[0]-t[0])<n&&Math.abs(e[1]-t[1])<n&&Math.abs(e[2]-t[2])<n},isOpposite:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return Math.abs(e[0]+t[0])<n&&Math.abs(e[1]+t[1])<n&&Math.abs(e[2]+t[2])<n}},ellipse:{pointInEllipse:x},lineSegment:A,rectangle:P},N=l(167);function B(e,t){var n=e.direction,a=e.spacing,o=n.slice(0,3),r=n.slice(3,6),i=n.slice(6,9),l=[N.vec3.dot(o,t),N.vec3.dot(r,t),N.vec3.dot(i,t)],c=N.vec3.create();return N.vec3.set(c,l[0]*a[0],l[1]*a[1],l[2]*a[2]),N.vec3.length(c)}function H(e,t,n){var a=t.viewPlaneNormal,o=e.getVolumeActors();if(!o&&!o.length)return{spacingInNormalDirection:null,imageVolume:null};var r=o.length,i=o.map((function(e){return s.cache.getVolume(e.uid)}));if(n){var l=i.find((function(e){return e.uid===n}));return{imageVolume:l,spacingInNormalDirection:B(l,a)}}for(var c={spacingInNormalDirection:1/0,imageVolume:null},d=0;d<r;d++){var u=i[d],v=B(u,a);v<c.spacingInNormalDirection&&(c.spacingInNormalDirection=v,c.imageVolume=u)}return c}function j(e,t,n){var a=t.viewPlaneNormal,o=e.filter((function(e){var t=e.metadata.viewPlaneNormal;return V.vec3.isEqual(t,a)}));if(!o.length)return[];for(var r=n/2,i=t.focalPoint,l=[],c=0;c<o.length;c++){var s=o[c],d=s.data.handles.points[0],u=N.vec3.create();N.vec3.sub(u,i,d);var v=N.vec3.dot(u,a);Math.abs(v)<r&&l.push(s)}return l}function F(e,t,n,a,o){var r,i,l=n.direction,c=l.slice(0,3),s=l.slice(3,6),d=l.slice(6,9),u=N.vec3.create();if(N.vec3.cross(u,t,e),u=[-u[0],-u[1],-u[2]],Math.abs(N.vec3.dot(c,t))>.999)r=0;else if(Math.abs(N.vec3.dot(s,t))>.999)r=1;else{if(!(Math.abs(N.vec3.dot(d,t))>.999))return console.warn("Can only currently do area calculation for orthogonal views."),{worldWidth:0,worldHeight:0};r=2}if(Math.abs(N.vec3.dot(c,u))>.999)i=0;else if(Math.abs(N.vec3.dot(s,u))>.999)i=1;else{if(!(Math.abs(N.vec3.dot(d,u))>.999))return console.warn("Can only currently do area calculation for orthogonal views."),{worldWidth:0,worldHeight:0};i=2}return{worldWidth:Math.abs(a[r]-o[r]),worldHeight:Math.abs(a[i]-o[i])}}var W=l(812),G=l.n(W);var z,q=function(e,t){var n=T(t,6),a=n[0],o=n[1],r=n[2],i=n[3],l=n[4],c=n[5];return e[0]>a&&e[0]<o&&e[1]>r&&e[1]<i&&e[2]>l&&e[2]<c};function K(e,t){var n=new e(t),a=void 0!==n.name&&""!==n.name,o=void 0!==Dt.tools[n.name];a?o?console.warn("".concat(n.name," has already been added globally")):Dt.tools[n.name]={toolClass:e,toolOptions:t}:console.warn("Tool with configuration did not produce a toolName: ",t)}function Y(){Dt.tools=[],Dt.toolGroups=[],Dt.synchronizers=[],Dt.enabledElements=[],Dt.isToolLocked=!1,Dt.isMultiPartToolActive=!1,Dt.handleRadius=6}!function(e){e.MOUSE_DOWN="cornerstonetools3dmousedown",e.MOUSE_UP="cornerstonetools3dmouseup",e.MOUSE_DOWN_ACTIVATE="cornerstonetools3dmousedownactivate",e.MOUSE_DRAG="cornerstonetools3dmousedrag",e.MOUSE_MOVE="cornerstonetools3dmousemove",e.MOUSE_CLICK="cornerstonetools3dmouseclick",e.MOUSE_DOUBLE_CLICK="cornerstonetools3dmousedoubleclick",e.MOUSE_WHEEL="cornerstonetools3dmousewheel",e.TOUCH_START="cornerstonetools3dtouchstart",e.TOUCH_START_ACTIVE="cornerstonetools3dtouchstartactive",e.TOUCH_END="cornerstonetools3dtouchend",e.TOUCH_DRAG="cornerstonetools3dtouchdrag",e.TOUCH_DRAG_END="cornerstonetools3dtouchdragend",e.TOUCH_PINCH="cornerstonetools3dtouchpinch",e.TOUCH_ROTATE="cornerstonetools3dtouchrotate",e.TOUCH_PRESS="cornerstonetools3dtouchpress",e.TAP="cornerstonetools3dtap",e.DOUBLE_TAP="cornerstonetools3ddoubletap",e.MULTI_TOUCH_START="cornerstonetools3dmultitouchstart",e.MULTI_TOUCH_START_ACTIVE="cornerstonetools3dmultitouchstartactive",e.MULTI_TOUCH_DRAG="cornerstonetools3dmultitouchdrag",e.KEY_DOWN="cornerstonetools3dkeydown",e.KEY_UP="cornerstonetools3dkeyup",e.KEY_PRESS="cornerstonetools3dkeypress"}(z||(z={}));var X=z;function $(e,t){var n=t||e.target,a=(0,s.getEnabledElement)(n),o=function(e){return[e.pageX,e.pageY]}(e),r=function(e,t){var n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,o),i=a.viewport.canvasToWorld(r);return{page:o,client:J(e),canvas:r,world:i}}function J(e){return[e.clientX,e.clientY]}var Z=function(e){var t=e.target,n=$(e,t),a={event:e,camera:{},element:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},eventName:X.MOUSE_DOUBLE_CLICK};(0,s.triggerEvent)(t,X.MOUSE_DOUBLE_CLICK,a)},Q=X.MOUSE_MOVE,ee=function(e){var t=e.currentTarget,n=(0,s.getEnabledElement)(t),a={renderingEngineUID:n.renderingEngineUID,sceneUID:n.sceneUID,viewportUID:n.viewportUID,camera:{},element:t,currentPoints:$(e),eventName:Q};(0,s.triggerEvent)(t,Q,a)},te=X.MOUSE_DOWN,ne=X.MOUSE_DOWN_ACTIVATE,ae={renderingEngingUID:void 0,sceneUID:void 0,viewportUID:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,element:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},oe={renderingEngingUID:void 0,sceneUID:void 0,viewportUID:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};function re(e){var t=$(e,oe.element),n=function(e,t){var n=e,a=(0,s.getEnabledElement)(n).viewport.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:a}}(oe.element,oe.lastPoints),a=de(t,n),o={renderingEngineUID:oe.renderingEngingUID,sceneUID:oe.sceneUID,viewportUID:oe.viewportUID,event:e,camera:{},element:oe.element,startPoints:ce(oe.startPoints),lastPoints:ce(n),currentPoints:t,deltaPoints:a,eventName:X.MOUSE_DRAG};(0,s.triggerEvent)(oe.element,X.MOUSE_DRAG,o),oe.lastPoints=ce(t)}function ie(e){clearTimeout(oe.preventClickTimeout);var t=oe.isClickEvent?X.MOUSE_CLICK:X.MOUSE_UP,n=$(e,oe.element),a=de(n,oe.lastPoints),o={renderingEngineUID:oe.renderingEngingUID,sceneUID:oe.sceneUID,viewportUID:oe.viewportUID,event:e,camera:{},element:oe.element,startPoints:ce(oe.startPoints),lastPoints:ce(oe.lastPoints),currentPoints:n,deltaPoints:a,eventName:t};(0,s.triggerEvent)(o.element,t,o),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ie),oe.element.addEventListener("mousemove",ee),oe=JSON.parse(JSON.stringify(ae))}function le(){oe.isClickEvent=!1}function ce(e){return JSON.parse(JSON.stringify(e))}function se(e,t){return[e[0]-t[0],e[1]-t[1]]}function de(e,t){return{page:se(e.page,t.page),client:se(e.client,t.client),canvas:se(e.canvas,t.canvas),world:(n=e.world,a=t.world,[n[0]-a[0],n[1]-a[1],n[2]-a[2]])};var n,a}var ue=function(e){oe.element=e.target;var t=(0,s.getEnabledElement)(oe.element),n=t.renderingEngineUID,a=t.sceneUID,o=t.viewportUID;oe.renderingEngingUID=n,oe.sceneUID=a,oe.viewportUID=o,oe.preventClickTimeout=setTimeout(le,oe.clickDelay),oe.element.removeEventListener("mousemove",ee);var r=$(e,oe.element),i=de(r,r),l={renderingEngineUID:oe.renderingEngingUID,sceneUID:oe.sceneUID,viewportUID:oe.viewportUID,event:e,camera:{},element:oe.element,startPoints:r,lastPoints:r,currentPoints:r,deltaPoints:i,eventName:te};oe.startPoints=ce(l.startPoints),oe.lastPoints=ce(l.lastPoints),(0,s.triggerEvent)(l.element,te,l)&&(l.eventName=ne,(0,s.triggerEvent)(l.element,ne,l)),document.addEventListener("mousemove",re),document.addEventListener("mouseup",ie)};function ve(e){e.removeEventListener("dblclick",Z),e.removeEventListener("mousedown",ue),e.removeEventListener("mousemove",ee)}var fe={enable:function(e){ve(e),e.addEventListener("dblclick",Z),e.addEventListener("mousedown",ue),e.addEventListener("mousemove",ee)},disable:ve},he=function(e){var t=e.currentTarget,n=(0,s.getEnabledElement)(t),a=n.renderingEngineUID,o=n.sceneUID,r=n.viewportUID;if(!(e.deltaY>-1&&e.deltaY<1)){e.preventDefault();var i=function(e){var t=0,n=0,a=0,o=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),a=10*t,o=10*n,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(a=e.deltaX),(a||o)&&e.deltaMode&&(1===e.deltaMode?(a*=40,o*=40):(a*=800,o*=800)),a&&!t&&(t=a<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:a,pixelY:o}}(e),l=i.spinX,c=i.spinY,d={renderingEngineUID:a,sceneUID:o,viewportUID:r,element:t,camera:{},detail:e,wheel:{spinX:l,spinY:c,pixelX:i.pixelX,pixelY:i.pixelY,direction:c<0?-1:1},points:$(e)};(0,s.triggerEvent)(t,X.MOUSE_WHEEL,d)}};function ge(e){e.removeEventListener("wheel",he)}var me,pe,be={enable:function(e){ge(e),e.addEventListener("wheel",he,{passive:!1})},disable:ge};!function(e){e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button"}(me||(me={})),pe||(pe={});var we,Ee={Mouse:me,Touch:pe};!function(e){e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled"}(we||(we={}));var _e=we;function De(e,t){if(Dt.svgNodeCache[e][t])return Dt.svgNodeCache[e][t].domRef}function ye(e,t,n,a){Dt.svgNodeCache[t][a]={touched:!0,domRef:n},e.appendChild(n)}function Ce(e,t){Dt.svgNodeCache[e][t]&&(Dt.svgNodeCache[e][t].touched=!0)}function Te(e,t){Object.keys(Dt.svgNodeCache[t]).forEach((function(n){var a=Dt.svgNodeCache[t][n];!a.touched&&a.domRef&&(e.removeChild(a.domRef),delete Dt.svgNodeCache[t][n])}))}var Ue=function(e,t){var n=function(e){var t=(0,s.getEnabledElement)(e),n=t.viewportUID,a=t.sceneUID,o=t.renderingEngineUID,r="".concat(n,":").concat(a,":").concat(o),i=function(e){return e.parentNode.querySelector(".svg-layer")}(e);return Object.keys(Dt.svgNodeCache[r]).forEach((function(e){Dt.svgNodeCache[r][e].touched=!1})),{enabledElement:t,_canvasElement:e,_svgLayerElement:i,_svgNodeCacheForCanvas:Dt.svgNodeCache,_getSvgNode:De.bind(this,r),_appendNode:ye.bind(this,i,r),_setNodeTouched:Ce.bind(this,r),_clearUntouched:Te.bind(this,i,r)}}(e);t(n),n._clearUntouched()},Ie=function(e,t,n,a){return"".concat(e,"::").concat(t,"::").concat(n,"::").concat(a)},Se=function(e,t,n,a,o,r){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=Object.assign({},{color:"dodgerblue",lineWidth:"2",lineDash:void 0},i),c=l.color,s=l.lineWidth,d=l.lineDash,u="http://www.w3.org/2000/svg",v=Ie(t,n,"ellipse",a),f=e._getSvgNode(v),h=Math.abs(o[0]-r[0]),g=Math.abs(o[1]-r[1]),m=Math.min(o[0],r[0]),p=Math.min(o[1],r[1]),b=[m+h/2,p+g/2],w=h/2,E=g/2;if(f)f.setAttribute("cx","".concat(b[0])),f.setAttribute("cy","".concat(b[1])),f.setAttribute("rx","".concat(w)),f.setAttribute("ry","".concat(E)),f.setAttribute("stroke",c),f.setAttribute("stroke-width",s),e._setNodeTouched(v);else{var _=document.createElementNS(u,"ellipse");_.setAttribute("cx","".concat(b[0])),_.setAttribute("cy","".concat(b[1])),_.setAttribute("rx","".concat(w)),_.setAttribute("ry","".concat(E)),_.setAttribute("fill","transparent"),_.setAttribute("stroke",c),_.setAttribute("stroke-width",s),d&&_.setAttribute("stroke-dasharray",d),e._appendNode(_,v)}},Me=function(e,t,n,a,o){for(var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=Object.assign({},{color:"dodgerblue",handleRadius:"6",width:"2",fill:"transparent",type:"circle"},r),l=i.color,c=i.handleRadius,s=i.width,d=i.fill,u=i.type,v=0;v<o.length;v++){var f=o[v],h="http://www.w3.org/2000/svg",g=Ie(t,n,"handle","hg-".concat(a,"-index-").concat(v)),m=e._getSvgNode(g);if(m){if("circle"===u)m.setAttribute("cx","".concat(f[0])),m.setAttribute("cy","".concat(f[1])),m.setAttribute("r",c),m.setAttribute("stroke",l),m.setAttribute("fill",d),m.setAttribute("stroke-width",s);else if("rect"===u){var p=parseFloat(c),b=1.5*p,w=f[0]-.5*b,E=f[1]-.5*b;m.setAttribute("x","".concat(w)),m.setAttribute("y","".concat(E)),m.setAttribute("width","".concat(b)),m.setAttribute("height","".concat(b)),m.setAttribute("stroke",l),m.setAttribute("fill",d),m.setAttribute("stroke-width",s),m.setAttribute("rx","".concat(.1*b))}e._setNodeTouched(g)}else{var _=document.createElementNS(h,u);if("circle"===u)_.setAttribute("cx","".concat(f[0])),_.setAttribute("cy","".concat(f[1])),_.setAttribute("r",c),_.setAttribute("stroke",l),_.setAttribute("fill",d),_.setAttribute("stroke-width",s);else if("rect"===u){var D=parseFloat(c),y=1.5*D,C=f[0]-.5*y,T=f[1]-.5*y;_.setAttribute("x","".concat(C)),_.setAttribute("y","".concat(T)),_.setAttribute("width","".concat(y)),_.setAttribute("height","".concat(y)),_.setAttribute("stroke",l),_.setAttribute("fill",d),_.setAttribute("stroke-width",s),_.setAttribute("rx","".concat(.1*y))}else console.warn("handle type not valid");e._appendNode(_,g)}}};function ke(e,t,n,a,o,r){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=Object.assign({},{color:"dodgerblue",width:"2",lineDash:void 0},i),c=l.color,s=l.width,d=l.lineDash,u="http://www.w3.org/2000/svg",v=Ie(t,n,"line",a),f=e._getSvgNode(v);if(f)f.setAttribute("x1",o[0]),f.setAttribute("y1",o[1]),f.setAttribute("x2",r[0]),f.setAttribute("y2",r[1]),f.setAttribute("stroke",c),f.setAttribute("stroke-width",s),e._setNodeTouched(v);else{var h=document.createElementNS(u,"line");h.setAttribute("x1","".concat(o[0])),h.setAttribute("y1","".concat(o[1])),h.setAttribute("x2","".concat(r[0])),h.setAttribute("y2","".concat(r[1])),h.setAttribute("stroke",c),h.setAttribute("stroke-width",s),d&&h.setAttribute("stroke-dasharray",d),e._appendNode(h,v)}}function xe(e,t,n,a,o,r,i){var l,c=i.padding,s=i.color,d=r[0]+c,u=r[1]+c,v=Ie(t,n,"text",a),f=e._getSvgNode(v);if(f){f.setAttribute("transform","translate(".concat(d," ").concat(u,")"));for(var h=f.querySelector("text"),g=Array.from(h.children),m=0;m<g.length;m++){var p=g[m],b=o[m]||"";p.textContent=b}s&&h.setAttribute("fill",s),l=f.getBBox(),e._setNodeTouched(v)}else{var w=document.createElementNS("http://www.w3.org/2000/svg","g");w.setAttribute("transform","translate(".concat(d," ").concat(u,")"));for(var E=function(e){var t=e.color,n=e.fontFamily,a=document.createElementNS("http://www.w3.org/2000/svg","text"),o="".concat("user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);").concat("filter:url(#shadow);");return a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("fill",t),a.setAttribute("font-family",n),a.setAttribute("style",o),a}(i),_=0;_<o.length;_++){var D=Oe(o[_]);E.appendChild(D)}w.appendChild(E),e._appendNode(w,v),l=w.getBBox()}return Object.assign({},l,{x:d,y:u,height:l.height+c,width:l.width+c})}function Oe(e){var t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}var Le=function(e,t,n,a,o,r){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=Object.assign({},{color:"dodgerblue",fontFamily:"Helvetica Neue,Helvetica,Arial,sans-serif",width:2,padding:25,fontSize:void 0,backgroundColor:"transparent",centerX:!1,centerY:!0},i),c=xe(e,t,n,a,o,r,l);return c};function Re(e){var t=e.x,n=e.y,a=e.height,o=e.width,r=o/2,i=a/2;return[[t+r,n],[t,n+i],[t+r,n+a],[t+o,n+i]]}var Ae=function(e,t,n,a,o,r,i){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},c=o.length>0?I(o,r):r,s=Re(i),d=I(s,c),u={lineDash:[2,3]},v=Object.assign({},u,l);ke(e,t,n,"link-".concat(a),c,d,v)},Pe=function(e,t,n,a,o,r,i,l){var c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:{},s=Object.assign({},{color:"dodgerblue",handleRadius:"6",width:"2",centering:{x:!1,y:!0}},c),d=Le(e,t,n,a,o,r,s);return Ae(e,t,n,a,i,r,d,s),d};function Ve(e,t,n,a,o,r){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=Object.assign({},{color:"dodgerblue",lineWidth:"2",lineDash:void 0},i),c=l.color,s=l.lineWidth,d=l.lineDash,u="http://www.w3.org/2000/svg",v=Ie(t,n,"rect",a),f=e._getSvgNode(v),h=[Math.min(o[0],r[0]),Math.min(o[1],r[1])],g=Math.abs(o[0]-r[0]),m=Math.abs(o[1]-r[1]);if(f)f.setAttribute("x","".concat(h[0])),f.setAttribute("y","".concat(h[1])),f.setAttribute("width","".concat(g)),f.setAttribute("height","".concat(m)),f.setAttribute("stroke",c),f.setAttribute("stroke-width",s),e._setNodeTouched(v);else{var p=document.createElementNS(u,"rect");p.setAttribute("x","".concat(o[0])),p.setAttribute("y","".concat(o[1])),p.setAttribute("width","".concat(g)),p.setAttribute("height","".concat(m)),p.setAttribute("fill","transparent"),p.setAttribute("stroke",c),p.setAttribute("stroke-width",s),d&&p.setAttribute("stroke-dasharray",d),e._appendNode(p,v)}}function Ne(e,t,n){for(var a=e.detail,o=a.renderingEngineUID,r=a.sceneUID,i=a.viewportUID,l=bt.getToolGroups(o,r,i),c=[],s=0;s<l.length;s++)for(var d=l[s],u=Object.keys(d.tools),v=0;v<u.length;v++){var f=u[v],h=d.tools[f];if(t.includes(h.mode)&&(!n||h.bindings.includes(n))){var g=d._tools[f];c.push(g)}}return c}var Be=_e.Active,He=_e.Passive,je=_e.Enabled,Fe=function(e){var t=e.detail.canvas,n=Ne(e,[Be,He,je]);Ue(t,(function(t){n.forEach((function(n){n.renderToolData&&n.renderToolData(e,t)}))}))},We=_e.Active;function Ge(e,t,n){if(Dt.isToolLocked)return!1;for(var a,o=n.detail,r=o.renderingEngineUID,i=o.sceneUID,l=o.viewportUID,c=bt.getToolGroups(r,i,l),s=0;s<c.length;s++){for(var d=c[s],u=Object.keys(d.tools),v=0;v<u.length;v++){var f=u[v],h=d.tools[f],g=d._tools[f];if(h.mode===We&&"function"==typeof g[t]){a=d._tools[f];break}}if(a)break}a&&a[t](n)}var ze=Ge.bind(null,"Mouse","mouseClickCallback"),qe=Ge.bind(null,"Mouse","doubleClickCallback");function Ke(e,t){for(var n=[],a=0;a<t.length;a++){var o=t[a];if(o){var r=Kt((0,s.getEnabledElement)(e),o.name);r&&("function"==typeof o.filterInteractableToolStateForElement&&(r=o.filterInteractableToolStateForElement(e,r)),r.length>0&&n.push({tool:o,toolState:r}))}else console.warn("undefined tool in getToolsWithDataForElement")}return n}var Ye=_e.Active;function Xe(e){for(var t=e.detail,n=t.renderingEngineUID,a=t.sceneUID,o=t.viewportUID,r=e.detail.event,i=bt.getToolGroups(n,a,o),l=0;l<i.length;l++)for(var c=i[l],s=Object.keys(c.tools),d=0;d<s.length;d++){var u=s[d],v=c.tools[u];if(v.mode===Ye&&v.bindings.includes(r.buttons))return c._tools[u]}}var $e=_e.Active,Je=_e.Passive;function Ze(e){if(!Dt.isToolLocked){var t=Xe(e);if(t&&"function"==typeof t.preMouseDownCallback&&t.preMouseDownCallback(e))return;var n=1===e.detail.event.buttons,a=Ne(e,[$e],e.detail.event.buttons),o=n?Ne(e,[Je]):void 0,r=[].concat(U(a||[]),U(o||[])),i=e.detail,l=i.element,c=Ke(l,r),s=i.currentPoints.canvas,d=function(e,t,n){if(0===t.length)return[];var a=[];return t.forEach((function(t){for(var o=t.tool,r=t.toolState,i=0;i<r.length;i++){var l=o.getHandleNearImagePoint(e,r[i],n,6);if(l){a.push({tool:o,toolData:r[i],handle:l});break}}})),a}(l,c,s);if(d.length>0){var u=d[0],v=u.tool,f=u.toolData,h=u.handle;v.handleSelectedCallback(e,f,h,"mouse")}else{var g=function(e,t,n){if(0===t.length)return[];var a=[];return t.forEach((function(t){for(var o=t.tool,r=t.toolState,i=0;i<r.length;i++)if(o.pointNearTool(e,r[i],n,6)){a.push({tool:o,toolData:r[i]});break}})),a}(l,c,s);if(g.length>0){var m=g[0],p=m.tool,b=m.toolData;p.toolSelectedCallback(e,b,"mouse")}else if(t&&"function"==typeof t.postMouseDownCallback&&t.postMouseDownCallback(e))return}}}function Qe(e){if(!Dt.isToolLocked){var t=Xe(e);t&&(Dt.isMultiPartToolActive||t.addNewMeasurement&&t.addNewMeasurement(e,"mouse"))}}function et(e){if(!Dt.isToolLocked){var t=Xe(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}}var tt=_e.Active,nt=_e.Passive;function at(e){if(!Dt.isToolLocked&&!Dt.isMultiPartToolActive){for(var t=Ne(e,[tt,nt]),n=e.detail.element,a=Ke(n,t),o=a.length,r=!1,i=0;i<o;i++){var l=a[i],c=l.tool,d=l.toolState;"function"==typeof c.mouseMoveCallback&&(r=c.mouseMoveCallback(e,d)||r)}!0===r&&(0,s.getEnabledElement)(n).viewport.render()}}var ot=Ge.bind(null,"Mouse","mouseUpCallback"),rt=Ge.bind(null,"MouseWheel","mouseWheelCallback"),it=function(e){e.addEventListener(X.MOUSE_CLICK,ze),e.addEventListener(X.MOUSE_DOWN,Ze),e.addEventListener(X.MOUSE_DOWN_ACTIVATE,Qe),e.addEventListener(X.MOUSE_DOUBLE_CLICK,qe),e.addEventListener(X.MOUSE_DRAG,et),e.addEventListener(X.MOUSE_MOVE,at),e.addEventListener(X.MOUSE_UP,ot),e.addEventListener(X.MOUSE_WHEEL,rt)},lt=function(e){e.removeEventListener(X.MOUSE_CLICK,ze),e.removeEventListener(X.MOUSE_DOWN,Ze),e.removeEventListener(X.MOUSE_DOWN_ACTIVATE,Qe),e.removeEventListener(X.MOUSE_DOUBLE_CLICK,qe),e.removeEventListener(X.MOUSE_DRAG,et),e.removeEventListener(X.MOUSE_MOVE,at),e.removeEventListener(X.MOUSE_UP,ot),e.removeEventListener(X.MOUSE_WHEEL,rt)},ct=_e.Active,st=_e.Passive,dt=_e.Enabled,ut=function(e){Ne(e,[ct,st,dt]).forEach((function(t){t.onCameraModified&&t.onCameraModified(e)}))};function vt(e){var t,n,a=e.detail.canvas,o=function(){var e="http://www.w3.org/2000/svg",t=document.createElementNS(e,"svg");t.classList.add("svg-layer"),t.setAttribute("id","svg-layer"),t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.style.width="100%",t.style.height="100%",t.style.pointerEvents="none",t.style.position="absolute";var n=document.createElementNS(e,"defs"),a=document.createElementNS(e,"filter"),o=document.createElementNS(e,"feOffset"),r=document.createElementNS(e,"feColorMatrix"),i=document.createElementNS(e,"feGaussianBlur"),l=document.createElementNS(e,"feBlend");return a.setAttribute("id","shadow"),a.setAttribute("width","110%"),a.setAttribute("height","110%"),o.setAttribute("result","offOut"),o.setAttribute("in","SourceGraphic"),o.setAttribute("dx","0.5"),o.setAttribute("dy","0.5"),r.setAttribute("result","matrixOut"),r.setAttribute("in","offOut"),r.setAttribute("type","matrix"),r.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),i.setAttribute("result","blurOut"),i.setAttribute("in","matrixOut"),i.setAttribute("stdDeviation","0.25"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","blurOut"),l.setAttribute("mode","normal"),a.appendChild(o),a.appendChild(r),a.appendChild(i),a.appendChild(l),n.appendChild(a),t.appendChild(n),t}();!function(e){var t=e.dataset,n=t.viewportUid,a=t.sceneUid,o=t.renderingEngineUid,r="".concat(n,":").concat(a,":").concat(o);Dt.svgNodeCache[r]={}}(a),t=o,(n=a).parentNode.insertBefore(t,n.nextSibling),fe.enable(a),be.enable(a),a.addEventListener(s.EVENTS.IMAGE_RENDERED,Fe),function(e){e.addEventListener(s.EVENTS.CAMERA_MODIFIED,ut)}(a),it(a),Dt.enabledElements.push(a)}var ft=function(e){var t,n,a=e.detail.canvas;fe.disable(a),be.disable(a),a.removeEventListener(s.EVENTS.IMAGE_RENDERED,Fe),function(e){e.removeEventListener(s.EVENTS.CAMERA_MODIFIED,ut)}(a),lt(a),t=a,(n=Dt.enabledElements.findIndex((function(e){return e===t})))>-1&&Dt.enabledElements.splice(n,1)},ht=_e.Active,gt=_e.Passive,mt=_e.Enabled,pt=_e.Disabled,bt={createToolGroup:function(e){if(!Dt.toolGroups.some((function(t){return t.id===e}))){var t={_tools:{},id:e,viewports:[],tools:{},getToolInstance:function(e){var t=this._tools[e];if(t)return t;console.warn("'".concat(e,"' is not registered with this toolGroup."))},addTool:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Dt.tools[e],a=void 0!==e&&""!==e,o=this.tools[e];if(a)if(n)if(o)console.warn("'".concat(e,"' is already registered for this ToolGroup."));else{var r=n.toolClass,i=n.toolOptions,l=Object.assign({},i,t),c=new r(l);this._tools[e]=c}else console.warn("'".concat(e,"' is not registered with the library."));else console.warn("Tool with configuration did not produce a toolName: ",t)},addViewports:function(e,t,n){this.viewports.push({renderingEngineUID:e,sceneUID:t,viewportUID:n})},setToolActive:function(e,t){if(void 0!==this._tools[e]){var n=Object.assign({bindings:[]},t,{mode:ht});this.tools[e]=n}else console.warn("Tool ".concat(e," not added to toolgroup, can't set tool mode."))},setToolPassive:function(e,t){if(void 0!==this._tools[e]){var n=Object.assign({bindings:[]},t,{mode:gt});this.tools[e]=n}else console.warn("Tool ".concat(e," not added to toolgroup, can't set tool mode."))},setToolEnabled:function(e,t){if(void 0!==this._tools[e]){var n=Object.assign({bindings:[]},t,{mode:mt});this.tools[e]=n}else console.warn("Tool ".concat(e," not added to toolgroup, can't set tool mode."))},setToolDisabled:function(e,t){if(void 0!==this._tools[e]){var n=Object.assign({bindings:[]},t,{mode:pt});this.tools[e]=n}else console.warn("Tool ".concat(e," not added to toolgroup, can't set tool mode."))}};return Dt.toolGroups.push(t),t}console.warn("'".concat(e,"' already exists."))},destroy:function(){Dt.toolGroups=[]},destroyToolGroupById:function(e){var t=Dt.toolGroups.findIndex((function(t){return t.id===e}));t>-1&&Dt.toolGroups.splice(t,1)},getToolGroupById:function(e){return Dt.toolGroups.find((function(t){return t.id===e}))},getToolGroups:function(e,t,n){return Dt.toolGroups.filter((function(a){return a.viewports.some((function(a){return!(a.renderingEngineUID!==e||a.viewportUID&&a.viewportUID!==n||a.sceneUID&&a.sceneUID!==t)}))}))}};function wt(e,t){return e.findIndex((function(e){return t.renderingEngineUID===e.renderingEngineUID&&t.sceneUID===e.sceneUID&&t.viewportUID===e.viewportUID}))}var Et=function(){function t(n,o,r){e(this,t),a(this,"_enabled",void 0),a(this,"_eventName",void 0),a(this,"_eventHandler",void 0),a(this,"_ignoreFiredEvents",void 0),a(this,"_sourceViewports",void 0),a(this,"_targetViewports",void 0),a(this,"id",void 0),this._enabled=!0,this._eventName=o,this._eventHandler=r,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this.id=n}return n(t,[{key:"isDisabled",value:function(){return!this._enabled||!this._hasSourceElements()}},{key:"add",value:function(e){this.addTarget(e),this.addSource(e)}},{key:"addSource",value:function(e){var t=e.renderingEngineUID,n=e.sceneUID,a=e.viewportUID;(0,s.getRenderingEngine)(t).getScene(n).getViewport(a).getCanvas().addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}},{key:"addTarget",value:function(e){this._targetViewports.push(e),this._updateDisableHandlers()}},{key:"destroy",value:function(){var e=this;this._sourceViewports.forEach((function(t){return e.removeSource(t)})),this._targetViewports.forEach((function(t){return e.removeTarget(t)}))}},{key:"remove",value:function(e){this.removeTarget(e),this.removeSource(e)}},{key:"removeSource",value:function(e){var t=wt(this._sourceViewports,e);if(-1!==t){var n,a=(n=e,(0,s.getRenderingEngine)(n.renderingEngineUID).getScene(n.sceneUID).getViewport(n.viewportUID).getCanvas());this._sourceViewports.splice(t,1),a.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}}},{key:"removeTarget",value:function(e){var t=wt(this._sourceViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}},{key:"hasSourceViewport",value:function(e,t,n){return this._sourceViewports.some((function(a){return a.renderingEngineUID===e&&a.sceneUID===t&&a.viewportUID===n}))}},{key:"fireEvent",value:function(e,t){if(!this.isDisabled()&&!this._ignoreFiredEvents){this._ignoreFiredEvents=!0;try{for(var n=0;n<this._targetViewports.length;n++){var a=this._targetViewports[n];e.viewportUID===a.viewportUID||this._eventHandler(this,e,a,t)}}catch(e){console.warn("Synchronizer, for: ".concat(this._eventName),e)}finally{this._ignoreFiredEvents=!1}}}},{key:"_onEvent",value:function(e){if(!0!==this._ignoreFiredEvents){var t=(0,s.getEnabledElement)(e.currentTarget),n=t.renderingEngineUID,a=t.sceneUID,o=t.viewportUID;this.fireEvent({renderingEngineUID:n,sceneUID:a,viewportUID:o},e)}}},{key:"_hasSourceElements",value:function(){return 0!==this._sourceViewports.length}},{key:"_updateDisableHandlers",value:function(){var e=function(e,t){for(var n=[],a=e.concat(t),o=function(e){var t=a[e];n.some((function(e){return t.renderingEngineUID===e.renderingEngineUID&&t.sceneUID===e.sceneUID&&t.viewportUID===e.viewportUID}))||n.push(t)},r=0;r<a.length;r++)o(r);return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=function(e){t(e.detail.element)};e.forEach((function(e){var t=(0,s.getRenderingEngine)(e.renderingEngineUID).getScene(e.sceneUID).getViewport(e.viewportUID).getCanvas();t.removeEventListener(s.EVENTS.ELEMENT_DISABLED,n),t.addEventListener(s.EVENTS.ELEMENT_DISABLED,n)}))}}]),t}(),_t={createSynchronizer:function(e,t,n){if(!Dt.synchronizers.some((function(t){return t.id===e}))){var a=new Et(e,t,n);return Dt.synchronizers.push(a),a}console.warn("'".concat(e,"' already exists."))},destroy:function(){for(;Dt.synchronizers.length>0;)Dt.synchronizers.pop().destroy()},getSynchronizerById:function(e){return Dt.synchronizers.find((function(t){return t.id===e}))},getSynchronizers:function(e,t,n){var a=[];if(!e&&!t&&!n)throw new Error("At least one of renderingEngineUID or sceneUID or viewportUID should be given");for(var o=0;o<Dt.synchronizers.length;o++){var r=Dt.synchronizers[o],i=!r.isDisabled(),l=r.hasSourceViewport(e,t,n);i&&l&&a.push(r)}return a},getAllSynchronizers:function(){return Dt.synchronizers}},Dt={isToolLocked:!1,isMultiPartToolActive:!1,tools:[],toolGroups:[],synchronizers:[],svgNodeCache:{},enabledElements:[],handleRadius:6},yt=_e.Active,Ct=_e.Passive,Tt=_e.Enabled;function Ut(e,t){var n=e.tools[t];if(!n)return!1;var a=n.mode;return a===yt||a===Ct||a===Tt}function It(e,t){var n=(0,s.getEnabledElement)(e),a=n.renderingEngine,o=n.FrameOfReferenceUID,r=a.getViewports();return(r=function(e,t){for(var n=e.length,a=[],o=0;o<n;o++){var r=e[o];bt.getToolGroups(r.renderingEngineUID,r.sceneUID,r.uid).some((function(e){return Ut(e,t)}))&&a.push(r)}return a}(r=function(e,t){for(var n=e.length,a=[],o=0;o<n;o++){var r=e[o];r.getFrameOfReferenceUID()===t&&a.push(r)}return a}(r,o),t)).map((function(e){return e.uid}))}function St(e,t){return!(e[0]<0||e[0]>=t[0]||e[1]<0||e[1]>=t[1]||e[2]<0||e[2]>=t[2])}function Mt(e){var t,n,a,o,r=(n=[(t=e)[0],t[1]].sort((function(e,t){return e[0]<t[0]?-1:1})),a=[t[0],t[1]].sort((function(e,t){return e[1]<t[1]?-1:1})),o=n[n.length-1],{top:a[0],bottom:a[a.length-1],right:o}),i=(r.top[1]+r.bottom[1])/2;return[r.right[0],i]}function kt(e,t,n,a,o,r){var i=n.min,l=n.max,c=n.current,s=N.vec3.create();N.vec3.sub(s,t,e);var d=Math.round((l-i)/o),u=(c-i)/(l-i)*d,v=Math.round(u),f=[e[0]-a[0]*u*o,e[1]-a[1]*u*o,e[2]-a[2]*u*o];(v+=r)>d?v=d:v<0&&(v=0);var h=v*o;return{newFocalPoint:f=[f[0]+a[0]*h,f[1]+a[1]*h,f[2]+a[2]*h],newPosition:[f[0]+s[0],f[1]+s[1],f[2]+s[2]]}}var xt=l(653),Ot=l.n(xt);function Lt(e,t,n){var a=function(e){var t=e.getMapper().getBounds();return[[t[0],t[2],t[4]],[t[0],t[2],t[5]],[t[0],t[3],t[4]],[t[0],t[3],t[5]],[t[1],t[2],t[4]],[t[1],t[2],t[5]],[t[1],t[3],t[4]],[t[1],t[3],t[5]]]}(e),o=Ot().buildFromDegree().identity().rotateFromDirections(t,[1,0,0]);a.forEach((function(e){return o.apply(e)}));var r=U(n);o.apply(r);for(var i=r[0],l=1/0,c=-1/0,s=0;s<8;s++){var d=a[s][0];d>c&&(c=d),d<l&&(l=d)}return{min:l,max:c,current:i}}var Rt=function(e,t,n){return Math.min(Math.max(t,e),n)};function At(e,t,n){var a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=e.detail,r=o.element,i=o.wheel,l=(0,s.getEnabledElement)(r),c=l.scene,d=l.viewport,u=d.type,v=d.getCamera(),f=v.focalPoint,h=v.viewPlaneNormal,g=v.position;if(d instanceof s.StackViewport){var m=d.getCurrentImageIdIndex(),p=d.getImageIds().length,b=i.direction,w=a?-b:b,E=m+w;E=Rt(E,0,p-1),d.setImageIdIndex(E)}else{if(!(d instanceof s.VolumeViewport))throw new Error("Not implemented for Viewport Type: ".concat(u));var _=H(c,v,n),D=_.spacingInNormalDirection,y=_.imageVolume;if(!y)return;var C=c.getVolumeActor(y.uid),T=Lt(C,h,f),U=kt(f,g,T,h,D,t),I=U.newFocalPoint,S=U.newPosition;d.setCamera({focalPoint:I,position:S}),d.render()}}function Pt(e){return(Pt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var Vt=function(e){var t=Pt(e);return null!==e&&("object"===t||"function"===t)},Nt=function(e){return e&&"object"===Pt(e)&&"[object RegExp]"!==Object.prototype.toString.call(e)&&"[object Date]"!==Object.prototype.toString.call(e)},Bt=function(e,t){var n;return t&&!0===t.clone&&Nt(e)?Ft((n=e,Array.isArray(n)?[]:{}),e,t):e},Ht=function(e,t,n){var a=e.slice();return t.forEach((function(t,o){void 0===a[o]?a[o]=Bt(t,n):Nt(t)?a[o]=Ft(e[o],t,n):-1===e.indexOf(t)&&a.push(Bt(t,n))})),a},jt=function(e,t,n){var a={};return Nt(e)&&Object.keys(e).forEach((function(t){a[t]=Bt(e[t],n)})),Object.keys(t).forEach((function(o){Nt(t[o])&&e[o]?a[o]=Ft(e[o],t[o],n):a[o]=Bt(t[o],n)})),a},Ft=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=Array.isArray(t),o=n||{arrayMerge:Ht},r=o.arrayMerge||Ht;return a?Array.isArray(e)?r(e,t,n):Bt(t,n):jt(e,t,n)},Wt=Ft,Gt=function(e,t,n){var a=!0,o=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Vt(n)&&(a="leading"in n?Boolean(n.leading):a,o="trailing"in n?Boolean(n.trailing):o),function(e,t,n){var a,o,r,i,l,c,s=0,d=!1,u=!1,v=!0,f=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function h(t){var n=a,r=o;return a=o=void 0,s=t,i=e.apply(r,n)}function g(e,t){return f?window.requestAnimationFrame(e):setTimeout(e,t)}function m(e){return s=e,l=g(b,t),d?h(e):i}function p(e){var n=e-c;return void 0===c||n>=t||n<0||u&&e-s>=r}function b(){var e=Date.now();if(p(e))return w(e);l=g(b,function(e){var n=e-s,a=t-(e-c);return u?Math.min(a,r-n):a}(e))}function w(e){return l=void 0,v&&a?h(e):(a=o=void 0,i)}function E(){for(var e=Date.now(),n=p(e),r=arguments.length,s=new Array(r),d=0;d<r;d++)s[d]=arguments[d];if(a=s,o=this,c=e,n){if(void 0===l)return m(c);if(u)return l=g(b,t),h(c)}return void 0===l&&(l=g(b,t)),i}return t=Number(t)||0,Vt(n)&&(d=Boolean(n.leading),r=(u="maxWait"in n)?Math.max(Number(n.maxWait)||0,t):r,v="trailing"in n?Boolean(n.trailing):v),E.cancel=function(){void 0!==l&&function(e){if(f)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),s=0,a=c=o=l=void 0},E.flush=function(){return void 0===l?i:w(Date.now())},E.pending=function(){return void 0!==l},E}(e,t,{leading:a,trailing:o,maxWait:t})};function zt(e,t){return void 0===e?t:e}function qt(e){return u}function Kt(e,t){var n=qt(),a=e.FrameOfReferenceUID;return n.get(a,t)}function Yt(e,t){var n=qt();void 0===t.metadata.toolUID&&(t.metadata.toolUID=o()),n.addToolState(t)}function Xt(){!function(){!function(){var e=s.EVENTS.ELEMENT_ENABLED,t=s.EVENTS.ELEMENT_DISABLED;s.eventTarget.removeEventListener(e,vt),s.eventTarget.removeEventListener(t,ft)}();var e=s.EVENTS.ELEMENT_ENABLED,t=s.EVENTS.ELEMENT_DISABLED;s.eventTarget.addEventListener(e,vt),s.eventTarget.addEventListener(t,ft)}()}function $t(e,t){e.save(),t(e),e.restore()}function Jt(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0,a=t.color,o=t.lineWidth,r=t.fillStyle,i=t.lineDash,l=t.shouldDrawLines,c=void 0===l||l;e.beginPath(),e.strokeStyle=a||e.strokeStyle,e.lineWidth=o||void 0===o&&D.getToolWidth()||e.lineWidth,i&&e.setLineDash(i),n(e),r&&(e.fillStyle=r,e.fill()),c&&e.stroke(),i&&e.setLineDash([])}function Zt(e,t,n,a){Jt(e,a,(function(e){e.moveTo(t[0],t[1]),e.lineTo(n[0],n[1])}))}function Qt(e,t,n,a){Jt(e,a,(function(e){e.moveTo(t[0],t[1]),n.forEach((function(t){e.lineTo(t[0],t[1])}))}))}s.triggerEvent;var en=k.findClosestPoint;function tn(e,t,n,a,o,r){var i=e.length>0?en(e,t):t,l=[[n.left+n.width/2,n.top],[n.left,n.top+n.height/2],[n.left+n.width/2,n.top+n.height],[n.left+n.width,n.top+n.height/2]];Zt(a,i,en(l,i),{color:o,lineWidth:r,lineDash:[2,3]})}function nn(e,t,n,a,o){var r=g.getFontSize();e.font=g.getFont(),e.textBaseline="top",e.fillStyle=a,n.forEach((function(n,a){e.fillText(n,t.left+o,t.top+o+a*(r+o))}))}function an(e,t,n){e.fillStyle=n,e.fillRect(t.left,t.top,t.width,t.height)}function on(e,t,n){var a=g.getFont(),o=e.font;a&&a!==o&&(e.font=a);var r=e.measureText(t).width;return a&&a!==o&&(e.font=o),r+2*n}function rn(e,t,n,a,o){var r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:void 0;"[object Array]"!==Object.prototype.toString.call(t)&&(t=[t]);var i=5,l=g.getFontSize(),c=g.getBackgroundColor(),s=0;t.forEach((function(t){var n=on(e,t,i);s=Math.max(s,n)}));var d={width:s,height:i+t.length*(l+i)};return $t(e,(function(e){e.strokeStyle=o,r&&r.centering&&!0===r.centering.x&&(n-=d.width/2),r&&r.centering&&!0===r.centering.y&&(a-=d.height/2),d.left=n,d.top=a;var l=r&&!0===r.debug?"#FF0000":c;an(e,d,l),nn(e,d,t,o,i)})),d}var ln={draw:$t,drawArrow:function(e,t,n,a,o){var r=Math.atan2(n[1]-t[1],n[0]-t[0]);Zt(e,void 0,t,n),Qt(e,void 0,n,[[n[0]-10*Math.cos(r-Math.PI/7),n[1]-10*Math.sin(r-Math.PI/7)],[n[0]-10*Math.cos(r+Math.PI/7),n[1]-10*Math.sin(r+Math.PI/7)],n])},drawCircle:function(e,t,n,a){Jt(e,a,(function(e){e.arc(t[0],t[1],n,0,2*Math.PI)}))},drawEllipse:function(e,t,n,a){var o=Math.abs(t[0]-n[0]),r=Math.abs(t[1]-n[1]),i=Math.min(t[0],n[0]),l=Math.min(t[1],n[1]),c=[i+o/2,l+r/2];Jt(e,a,(function(e){e.ellipse(c[0],c[1],o/2,r/2,0,0,2*Math.PI),e.closePath()}))},drawHandles:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=w.getToolColor();e.strokeStyle=n.color||a;for(var o=Object.keys(t),r=function(a){var r=o[a],i=t[r];if(!0===i.drawnIndependently)return"continue";if(!0===n.drawHandlesIfActive&&!i.active)return"continue";var l=i.active?D.getActiveWidth():D.getToolWidth(),c=n.fill;Jt(e,{lineWidth:l,fillStyle:c},(function(e){var t=i.radius||n.handleRadius||Dt.handleRadius;e.arc(i[0],i[1],t,0,2*Math.PI)}))},i=0;i<o.length;i++)r(i)},drawJoinedLines:Qt,drawLine:Zt,drawLines:function(e,t,n){Jt(e,n,(function(e){t.forEach((function(t){var n=t.start,a=t.end;e.moveTo(n[0],n[1]),e.lineTo(a[0],a[1])}))}))},drawLink:tn,drawLinkedTextBox:function(e,t,n,a,o,r,i,l,c,s){c&&(t[0]+=c);var d={centering:{x:!1,y:s}},u=rn(e,n,t[0],t[1],i,d);a.hasMoved&&tn(o,t,u,e,i,l);var v=u.top,f=u.left,h=u.width,g=u.height;a.worldBoundingBox={topLeft:r([f,v]),topRight:r([f+h,v]),bottomLeft:r([f,v+g]),bottomRight:r([f+h,v+g])}},drawRect:function(e,t,n,a){var o=Math.abs(t[0]-n[0]),r=Math.abs(t[1]-n[1]),i=[Math.min(t[0],n[0]),Math.min(t[1],n[1])],l=[i[0]+o,i[1]+r],c=[i[0]+o,i[1]],s=[i[0],i[1]+r];Jt(e,a,(function(e){e.moveTo(i[0],i[1]),e.lineTo(c[0],c[1]),e.moveTo(c[0],c[1]),e.lineTo(l[0],l[1]),e.moveTo(l[0],l[1]),e.lineTo(s[0],s[1]),e.moveTo(s[0],s[1]),e.lineTo(i[0],i[1])}))},drawTextBox:rn,fillBox:an,fillOutsideRect:function(e,t,n,a){var o=Math.min(t[0],n[0]),r=Math.min(t[1],n[1]),i=Math.abs(t[0]-n[0]),l=Math.abs(t[1]-n[1]);Jt(e,a,(function(e){e.rect(0,0,e.canvas.clientWidth,e.canvas.clientHeight),e.rect(o+i,r,-i,l)}))},fillTextLines:nn,getNewContext:function(e){return e.getContext("2d")},path:Jt,setShadow:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.shadow&&(e.shadowColor=zt(t.shadowColor,"#000000"),e.shadowBlur=zt(t.shadowBlur,0),e.shadowOffsetX=zt(t.shadowOffsetX,1),e.shadowOffsetY=zt(t.shadowOffsetY,1))}};function cn(e,t,n,a){if(t.renderingEngineUID!==n.renderingEngineUID||t.sceneUID!==n.sceneUID||t.viewportUID!==n.viewportUID){var o=a.detail.camera,r=(0,s.getRenderingEngine)(n.renderingEngineUID).getScene(n.sceneUID).getViewport(n.viewportUID);r.setCamera(o),r.render()}}var sn=s.EVENTS.CAMERA_MODIFIED;function dn(e,t,n,a){var o=a.detail,r=o.volumeUID,i=o.sceneUID,l=o.range,c=(0,s.getRenderingEngine)(n.renderingEngineUID);if(!c)throw new Error("Rendering Engine does not exist: ".concat(n.renderingEngineUID));var d=c.getScene(n.sceneUID);if(d.uid!==i){var u=d.getViewport(n.viewportUID);d.getVolumeActor(r).getProperty().getRGBTransferFunction(0).setRange(l.lower,l.upper),u.render()}}var un=s.EVENTS.VOI_MODIFIED,vn={createCameraPositionSynchronizer:function(e){return _t.createSynchronizer(e,sn,cn)},createVOISynchronizer:function(e){return _t.createSynchronizer(e,un,dn)}},fn=function(){function t(n,o){e(this,t),a(this,"initialConfiguration",void 0),a(this,"name",void 0),a(this,"supportedInteractionTypes",void 0),a(this,"strategies",void 0),a(this,"defaultStrategy",void 0),a(this,"activeStrategy",void 0),a(this,"configuration",void 0),this.initialConfiguration=Wt(n,o);var r=this.initialConfiguration,i=r.name,l=r.strategies,c=r.defaultStrategy,s=r.configuration,d=void 0===s?{}:s,u=r.supportedInteractionTypes;this.name=i,this.supportedInteractionTypes=u||[],this.strategies=l||{},this.defaultStrategy=c||Object.keys(this.strategies)[0]||void 0,this.activeStrategy=this.defaultStrategy,this.configuration=Object.assign({},d)}return n(t,[{key:"applyActiveStrategy",value:function(e,t){return this.strategies[this.activeStrategy].call(this,e,t)}},{key:"setActiveStrategyName",value:function(e){this.activeStrategy=e}}]),t}();function hn(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function gn(e,t){return(gn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function mn(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&gn(e,t)}function pn(e,t){return!t||"object"!==Pt(t)&&"function"!=typeof t?hn(e):t}function bn(e){return(bn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var wn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t;e(this,l);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return a(hn(t=i.call.apply(i,[this].concat(o))),"mouseMoveCallback",(function(e,n){for(var a=e.detail,o=a.element,r=a.currentPoints.canvas,i=!1,l=0;l<n.length;l++){var c=n[l],s=c.data,d=s.handles?s.handles.activeHandleIndex:void 0,u=t._imagePointNearToolOrHandle(o,c,r,6),v=u&&!s.active,f=!u&&s.active;v||f?(s.active=!s.active,i=!0):s.handles&&s.handles.activeHandleIndex!==d&&(i=!0)}return i})),t}return n(l,[{key:"_imagePointNearToolOrHandle",value:function(e,t,n,a){return!!this.getHandleNearImagePoint(e,t,n,a)||this.pointNearTool(e,t,n,a,"mouse")}}]),l}(fn);var En=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"Pan",supportedInteractionTypes:["Mouse","Touch"]})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),t.touchDragCallback=t._dragCallback.bind(hn(t)),t.mouseDragCallback=t._dragCallback.bind(hn(t)),t}return n(l,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,a=t.deltaPoints,o=(0,s.getEnabledElement)(n),r=a.world,i=o.viewport.getCamera(),l=i.focalPoint,c=i.position,d=[c[0]-r[0],c[1]-r[1],c[2]-r[2]],u=[l[0]-r[0],l[1]-r[1],l[2]-r[2]];o.viewport.setCamera({focalPoint:u,position:d}),o.viewport.render()}}]),l}(fn),_n=l(708);var Dn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"WindowLevel",supportedInteractionTypes:["Mouse","Touch"]})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_getImageDynamicRange",(function(e){var t=(0,s.getVolume)(e),n=t.dimensions,a=t.scalarData,o=Math.floor(n[2]/2);if(t instanceof _n.StreamingImageVolume){if(!t.loadStatus.cachedFrames[o])return yn;var r,i,l=n[0]*n[1];a instanceof Float32Array?(r=4,i=Float32Array):a instanceof Uint8Array&&(r=1,i=Uint8Array);for(var c=new i(a.buffer,o*l*r,l),d=1/0,u=-1/0,v=0;v<l;v++){var f=c[v];f<d&&(d=f),f>u&&(u=f)}return u-d}})),t.touchDragCallback=t._dragCallback.bind(hn(t)),t.mouseDragCallback=t._dragCallback.bind(hn(t)),t}return n(l,[{key:"_toWindowLevel",value:function(e,t){var n=Math.abs(e-t);return{windowWidth:n,windowCenter:e+n/2}}},{key:"_toLowHighRange",value:function(e,t){return{lower:t-e/2,upper:t+e/2}}},{key:"_dragCallback",value:function(e){var t,n=e.detail,a=n.element,o=n.deltaPoints,r=(0,s.getEnabledElement)(a),i=r.scene,l=r.sceneUID,c=r.viewport,d=c.getDefaultActor().uid;if(c instanceof s.VolumeViewport&&d)t=i.getVolumeActor(d);else{var u=c.getActors();u&&u.length&&(t=u[0].volumeActor)}if(t){var v=t.getProperty().getRGBTransferFunction(0),f=o.canvas,h=4;if(c instanceof s.VolumeViewport&&d){var g=this._getImageDynamicRange(d);h=Math.round(g/1024)}var m=f[0]*h,p=f[1]*h,b=T(v.getRange(),2),w=b[0],E=b[1],_=this._toWindowLevel(w,E),D=_.windowWidth,y=_.windowCenter;D+=m,y+=p,D=Math.max(D,1);var C=this._toLowHighRange(D,y);v.setMappingRange(C.lower,C.upper);var U={volumeUID:d,sceneUID:l,range:C};(0,s.triggerEvent)(a,s.EVENTS.VOI_MODIFIED,U),i||c instanceof s.VolumeViewport?i.render():(c.setStackActorVOI(C),c.render())}}}]),l}(fn),yn=1024;var Cn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"PetThreshold",supportedInteractionTypes:["Mouse","Touch"]})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_configuration",void 0),t.touchDragCallback=t._dragCallback.bind(hn(t)),t.mouseDragCallback=t._dragCallback.bind(hn(t)),t}return n(l,[{key:"_dragCallback",value:function(e){var t,n=e.detail,a=n.element,o=n.deltaPoints,r=(0,s.getEnabledElement)(a),i=r.scene,l=r.sceneUID,c=r.viewport.getDefaultActor().uid;if(c){if(!(t=i.getVolumeActor(c)))throw new Error("Scene does not have a volume actor with specified volumeUID: ".concat(c))}else{var d=i.getVolumeActors();d&&d.length&&(t=d[0].volumeActor)}if(t){var u=t.getProperty().getRGBTransferFunction(0),v=o.canvas[1]*(5/a.clientHeight),f=u.getRange(),h=f[0],g=f[1];g-=v,g=Math.max(g,.1),u.setMappingRange(h,g);var m={volumeUID:c,sceneUID:l,range:{lower:h,upper:g}};(0,s.triggerEvent)(a,s.EVENTS.VOI_MODIFIED,m),i.render()}}}]),l}(fn);var Tn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"StackScroll",invert:!1,supportedInteractionTypes:["Mouse","Touch"]})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_configuration",void 0),t.touchDragCallback=t._dragCallback.bind(hn(t)),t.mouseDragCallback=t._dragCallback.bind(hn(t)),t}return n(l,[{key:"_dragCallback",value:function(e){var t=e.detail.deltaPoints.canvas[1],n=this.configuration;At(e,t,n.volumeUID,n.invert)}}]),l}(fn);var Un=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"StackScrollMouseWheel",supportedInteractionTypes:["Mouse","Touch"]})),"_configuration",void 0),t}return n(l,[{key:"mouseWheelCallback",value:function(e){At(e,e.detail.wheel.direction,this.configuration.volumeUID)}}]),l}(fn);var In=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"Zoom",supportedInteractionTypes:["Mouse","Touch"]})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_dragParallelProjection",(function(e,t){var n=e.detail,a=n.element,o=n.deltaPoints,r=(0,s.getEnabledElement)(a).viewport,i=1.5/(a.clientWidth,a.clientHeight),l=o.canvas[1]*i;r.setCamera({parallelScale:(1-l)*t.parallelScale})})),a(hn(t),"_dragPerspectiveProjection",(function(e,t){var n=e.detail,a=n.element,o=n.deltaPoints,r=(0,s.getEnabledElement)(a).viewport,i=[a.clientWidth,a.clientHeight],l=t.clippingRange[1]/i[1]*1.5,c=t.position,d=t.focalPoint,u=t.viewPlaneNormal,v=[-u[0],-u[1],-u[2]],f=o.canvas[1]*l,h=f*v[0];c[0]+=h,d[0]+=h,h=f*v[1],c[1]+=h,d[1]+=h,h=f*v[2],c[2]+=h,d[2]+=h,r.setCamera({position:c,focalPoint:d})})),t.touchDragCallback=t._dragCallback.bind(hn(t)),t.mouseDragCallback=t._dragCallback.bind(hn(t)),t}return n(l,[{key:"_dragCallback",value:function(e){var t=e.detail.element,n=(0,s.getEnabledElement)(t).viewport,a=n.getCamera();a.parallelProjection?this._dragParallelProjection(e,a):this._dragPerspectiveProjection(e,a),n.render()}}]),l}(fn);var Sn={X:[1,0,0],Y:[0,1,0],Z:[0,0,1],CUSTOM:[]},Mn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,l);var o={name:"VolumeRotateMouseWheel",supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:Sn.Z,rotateIncrementDegrees:20}};return a(hn(t=i.call(this,n,o)),"_configuration",void 0),t}return n(l,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.element,a=t.wheel,o=(0,s.getEnabledElement)(n).viewport,r=this.configuration,i=r.direction,l=r.rotateIncrementDegrees,c=o.getCamera(),d=c.viewUp,u=c.position,v=c.focalPoint,f=a.direction,h=T(v,3),g=h[0],m=h[1],p=h[2],b=T(i,3),w=b[0],E=b[1],_=b[2],D=f*l,y=[0,0,0],C=[0,0,0],U=[0,0,0],I=N.mat4.identity(new Float32Array(16));N.mat4.translate(I,I,[g,m,p]),N.mat4.rotate(I,I,D,[w,E,_]),N.mat4.translate(I,I,[-g,-m,-p]),N.vec3.transformMat4(y,u,I),N.vec3.transformMat4(C,v,I),N.mat4.identity(I),N.mat4.rotate(I,I,D,[w,E,_]),N.vec3.transformMat4(U,d,I),o.setCamera({position:y,viewUp:U,focalPoint:C}),o.render()}}]),l}(fn);function kn(e){On(e,"initial")}function xn(e){On(e,"none")}function On(e,t){e.style.cursor=t}var Ln=V.vec2.liangBarksyClip,Rn=V.vec3,An=Rn.isEqual,Pn=Rn.isOpposite;function Vn(){return"rgb(200, 200, 200)"}function Nn(){return!0}function Bn(){return!0}function Hn(){return!1}var jn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"Crosshairs",supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0}})),"toolCenter",[0,0,0]),a(hn(t),"_getReferenceLineColor",void 0),a(hn(t),"_getReferenceLineControllable",void 0),a(hn(t),"_getReferenceLineDraggableRotatable",void 0),a(hn(t),"_getReferenceLineSlabThicknessControlsOn",void 0),a(hn(t),"editData",void 0),a(hn(t),"getHandleNearImagePoint",(function(e,n,a,o){var r,i,l=e.dataset,c=l.viewportUid,d=l.sceneUid,u=l.renderingEngineUid;if("Active"===(null===(i=(null===(r=bt.getToolGroups(u,d,c)[0])||void 0===r?void 0:r.tools)[t.name])||void 0===i?void 0:i.mode)){var v=(0,s.getEnabledElement)(e).viewport,f=t._getRotationHandleNearImagePoint(v,n,a,o);return null!==f||null!==(f=t._getSlabThicknessHandleNearImagePoint(v,n,a,o))?f:void 0}})),a(hn(t),"handleSelectedCallback",(function(e,n,a){var o=e.detail.element;n.data.active=!0,t._activateModify(o),xn(o),e.preventDefault()})),a(hn(t),"pointNearTool",(function(e,n,a,o,r){var i,l,c=e.dataset,d=c.viewportUid,u=c.sceneUid,v=c.renderingEngineUid,f=bt.getToolGroups(v,u,d);if("Active"!==(null===(l=(null===(i=f[0])||void 0===i?void 0:i.tools)[t.name])||void 0===l?void 0:l.mode))return!1;for(var h=0;h<f.length&&"Active"!==f[h].tools.Crosshairs.mode;++h);var g=n.data;if(t._pointNearTool(e,n,a,6))return!0;if(0===g.activeViewportUIDs.length){var m=(0,s.getEnabledElement)(e),p=m.viewport.canvasToWorld(a);t._jump(m,p);for(var b=g.handles.rotationPoints,w=[],E=0;E<b.length-1;++E){var _=b[E][1],D=t._getReferenceLineControllable(_.uid),y=t._getReferenceLineDraggableRotatable(_.uid);D&&y&&(w.push(_.uid),E++)}return g.activeViewportUIDs=[].concat(w),g.handles.activeOperation=1,!0}return!1})),a(hn(t),"toolSelectedCallback",(function(e,n){var a=e.detail.element;n.data.active=!0,t._activateModify(a),xn(a),e.preventDefault()})),a(hn(t),"onCameraModified",(function(e){var n=e.detail.canvas,a=(0,s.getEnabledElement)(n),o=a.FrameOfReferenceUID,r=a.renderingEngine,i=a.viewport,l=It(n,t.name),c=Kt(a,t.name),d=t.filterInteractableToolStateForElement(n,c);!d.length&&o&&(t._initCrosshairs(e,c),c=Kt(a,t.name),d=t.filterInteractableToolStateForElement(n,c));var u=d[0];if(u){var v=i.getCamera(),f=u.metadata.cameraPosition,h=[0,0,0];G().subtract(v.position,f,h);var g=u.metadata.cameraFocalPoint,m=[0,0,0];G().subtract(v.focalPoint,g,m),u.metadata.cameraPosition=U(v.position),u.metadata.cameraFocalPoint=U(v.focalPoint);var p=t._getReferenceLineControllable(i.uid),b=t._getReferenceLineDraggableRotatable(i.uid);if(!An(v.position,f,.001)&&p&&b){var w=!0;if(An(h,m,.001)||(w=!1),w&&Math.abs(G().dot(h,v.viewPlaneNormal))>.01){for(var E=t._filterLinkedViewportWithSameOrientationAndScene(a,c),_=0;_<E.length;++_){var D=E[_],y=D.data,C=r.getScene(y.sceneUID).getViewport(y.viewportUID),T=C.getCamera(),I=[0,0,0],S=[0,0,0];G().add(T.focalPoint,h,I),G().add(T.position,h,S),D.metadata.cameraPosition=U(v.position),D.metadata.cameraFocalPoint=U(v.focalPoint),C.setCamera({focalPoint:I,position:S})}t.toolCenter[0]+=h[0],t.toolCenter[1]+=h[1],t.toolCenter[2]+=h[2]}}}r.renderViewports(l)})),a(hn(t),"mouseMoveCallback",(function(e,n){for(var a=e.detail,o=a.element,r=a.currentPoints.canvas,i=!1,l=0;l<n.length;l++){var c=n[l],s=c.data;if(s.handles){var d=s.handles.activeOperation,u=s.activeViewportUIDs&&s.activeViewportUIDs.length>0?U(s.activeViewportUIDs):[];s.activeViewportUIDs=[],s.handles.activeOperation=null;var v,f=(v=!!t.getHandleNearImagePoint(o,c,r,6)||t._pointNearTool(o,c,r,6))&&!s.active,h=!v&&s.active;f||h?(s.active=!s.active,i=!0):s.handles.activeOperation===d&&t._areViewportUIDArraysEqual(s.activeViewportUIDs,u)||(i=!0)}}return i})),a(hn(t),"_areViewportUIDArraysEqual",(function(e,t){return e.length===t.length&&(e.forEach((function(e){for(var n=!1,a=0;a<t.length;++a)if(e===t[a]){n=!0;break}if(!1===n)return!1})),!0)})),a(hn(t),"_filterViewportOrientations",(function(e,t){var n=e.viewportUID,a=e.renderingEngine,o=e.viewport,r=t.filter((function(e){return e.data.viewportUID!==n}));if(!r||!r.length)return[];var i=o.getCamera(),l=i.viewPlaneNormal,c=i.position;return r.filter((function(e){var t=e.data,n=t.sceneUID,o=t.viewportUID,r=a.getScene(n).getViewport(o).getCamera();return!(An(r.viewPlaneNormal,l,.01)&&An(r.position,c,1))}))})),a(hn(t),"_filterLinkedViewportWithSameOrientationAndScene",(function(e,n){var a=e.scene,o=e.renderingEngine,r=e.viewport,i=t._getReferenceLineControllable(r.uid),l=n.filter((function(e){var n=e.data,l=o.getScene(n.sceneUID),c=l.getViewport(n.viewportUID),s=t._getReferenceLineControllable(c.uid);return r!==c&&a===l&&!0===s&&!0===i}));if(!l||!l.length)return[];var c=r.getCamera(),s=c.viewPlaneNormal;return G().normalize(s),l.filter((function(e){var t=e.data,n=t.sceneUID,a=t.viewportUID,r=o.getScene(n).getViewport(a).getCamera(),i=r.viewPlaneNormal;return G().normalize(i),An(s,i,.01)&&An(c.viewUp,r.viewUp,.01)}))})),a(hn(t),"_filterUniqueViewportOrientations",(function(e,n){var a=e.renderingEngine,o=e.scene,r=e.viewport,i=r.getCamera().viewPlaneNormal;G().normalize(i);for(var l=n.filter((function(e){var n=e.data,i=a.getScene(n.sceneUID),l=i.getViewport(n.viewportUID),c=t._getReferenceLineControllable(l.uid);return r!==l&&o===i&&!0===c})),c=[],s=0;s<l.length;++s){var d=l[s],u=d.data,v=u.sceneUID,f=u.viewportUID,h=a.getScene(v).getViewport(f).getCamera(),g=h.viewPlaneNormal;if(G().normalize(g),!An(i,g,.01)&&!Pn(i,g,.01)){for(var m=!1,p=0;p<c.length;++p){var b=c[p].data,w=b.sceneUID,E=b.viewportUID,_=a.getScene(w).getViewport(E).getCamera();An(_.viewPlaneNormal,h.viewPlaneNormal,.01)&&An(_.position,h.position,1)&&(m=!0)}m||c.push(d)}}for(var D=n.filter((function(e){var n=e.data,i=a.getScene(n.sceneUID),l=i.getViewport(n.viewportUID),c=t._getReferenceLineControllable(l.uid);return r!==l&&o===i&&!0!==c})),y=0;y<D.length;++y){var C=D[y],T=C.data,U=T.sceneUID,I=T.viewportUID,S=a.getScene(U).getViewport(I).getCamera(),M=S.viewPlaneNormal;if(G().normalize(M),!An(i,M,.01)&&!Pn(i,M,.01)){for(var k=!1,x=0;x<c.length;++x){var O=c[x].data,L=O.sceneUID,R=O.viewportUID,A=a.getScene(L).getViewport(R).getCamera();An(A.viewPlaneNormal,S.viewPlaneNormal,.01)&&An(A.position,S.position,1)&&(k=!0)}k||c.push(C)}}for(var P=t._filterViewportOrientations(e,n),V=function(e){var t=P[e];if(!0===c.find((function(e){return e===t})))return"continue";var n=t.data,o=n.sceneUID,r=n.viewportUID,l=a.getScene(o).getViewport(r).getCamera(),s=l.viewPlaneNormal;if(G().normalize(s),An(i,s,.01)||Pn(i,s,.01))return"continue";for(var d=!1,u=0;u<c.length;++u){var v=c[u].data,f=v.sceneUID,h=v.viewportUID,g=a.getScene(f).getViewport(h).getCamera();An(g.viewPlaneNormal,l.viewPlaneNormal,.01)&&An(g.position,l.position,1)&&(d=!0)}d||c.push(t)},N=0;N<P.length;++N)V(N);return c})),a(hn(t),"_initCrosshairs",(function(e,n){var a=e.detail.canvas,o=(0,s.getEnabledElement)(a),r=o.viewport,i=o.FrameOfReferenceUID,l=o.viewportUID,c=o.sceneUID,d=r.sHeight,u=r.sWidth,v=r.canvasToWorld,f=[.5*u,.5*d];t.toolCenter=v(f);var h=r.getCamera(),g=h.position,m=h.focalPoint;Yt(0,{metadata:{cameraPosition:U(g),cameraFocalPoint:U(m),FrameOfReferenceUID:i,toolName:t.name},data:{handles:{rotationPoints:[],slabThicknessPoints:[]},active:!1,activeOperation:null,activeViewportUIDs:[],viewportUID:l,sceneUID:c}}),kn(a)})),a(hn(t),"_jump",(function(e,n){Dt.isToolLocked=!0;var a=Kt(e,t.name),o=e.renderingEngine,r=e.scene,i=[0,0,0];G().subtract(n,t.toolCenter,i);var l=t._filterViewportOrientations(e,a).filter((function(e){var n=e.data,a=o.getScene(n.sceneUID),i=a.getViewport(n.viewportUID);return t._getReferenceLineControllable(i.uid)&&t._getReferenceLineDraggableRotatable(i.uid)&&a===r}));return 0===l.length?(Dt.isToolLocked=!1,!1):(t._applyDeltaShiftToSelectedViewportCameras(o,l,i),Dt.isToolLocked=!1,!0)})),a(hn(t),"jumpToWorld",(function(e,n){Dt.isToolLocked=!0;var a=Kt(e,t.name),o=e.renderingEngine,r=e.viewport,i=[0,0,0];G().subtract(n,t.toolCenter,i);var l=a.find((function(e){return e.data.viewportUID===r.uid}));return t._applyDeltaShiftToViewportCamera(o,l,i),Dt.isToolLocked=!1,!0})),a(hn(t),"_pointNearReferenceLine",(function(e,n,a,o){for(var r=e.data.handles.rotationPoints,i=0;i<r.length-1;++i){var l=r[i][1];if(l.uid===o.uid&&t._getReferenceLineControllable(l.uid)){var c={start:{x:r[i][2][0],y:r[i][2][1]},end:{x:r[i][3][0],y:r[i][3][1]}},s=A.distanceToPoint([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]),d={start:{x:r[i+1][2][0],y:r[i+1][2][1]},end:{x:r[i+1][3][0],y:r[i+1][3][1]}},u=A.distanceToPoint([d.start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]]);if(s<=a||u<=a)return!0;i++}}return!1})),t._getReferenceLineColor=n.configuration&&n.configuration.getReferenceLineColor||Vn,t._getReferenceLineControllable=n.configuration&&n.configuration.getReferenceLineControllable||Nn,t._getReferenceLineDraggableRotatable=n.configuration&&n.configuration.getReferenceLineDraggableRotatable||Bn,t._getReferenceLineSlabThicknessControlsOn=n.configuration&&n.configuration.getReferenceLineSlabThicknessControlsOn||Hn,t._activateModify=t._activateModify.bind(hn(t)),t._deactivateModify=t._deactivateModify.bind(hn(t)),t._mouseUpCallback=t._mouseUpCallback.bind(hn(t)),t._mouseDragCallback=t._mouseDragCallback.bind(hn(t)),t}return n(l,[{key:"addNewMeasurement",value:function(e,t){}},{key:"filterInteractableToolStateForElement",value:function(e,t){if(!t||!t.length)return[];var n=(0,s.getEnabledElement)(e).viewportUID;return t.filter((function(e){return e.data.viewportUID===n}))}},{key:"renderToolData",value:function(e,t){for(var n=this,a=e.detail,o=a.renderingEngineUID,r=a.sceneUID,i=a.viewportUID,l=bt.getToolGroups(o,r,i),c=!1,s=0;s<l.length;++s)if("Active"===l[s].tools.Crosshairs.mode){c=!0;break}if(c){var d=e.detail.canvas,u=Kt(t.enabledElement,this.name),v=t.enabledElement,f=v.renderingEngine,h=v.viewport,g=h.getCamera(),m=this.filterInteractableToolStateForElement(d,u)[0];if(u&&m&&m.data){var p=m.metadata.toolUID,b=h.sWidth,w=h.sHeight,E=Math.sqrt(b*b+w*w),_=m.data,D=h.worldToCanvas(this.toolCenter),y=this._filterUniqueViewportOrientations(t.enabledElement,u),C=[];y.forEach((function(e){var t=e.data,a=f.getScene(t.sceneUID).getViewport(t.viewportUID),o=a.getCamera(),r=n._getReferenceLineControllable(a.uid),i=n._getReferenceLineDraggableRotatable(a.uid),l=n._getReferenceLineSlabThicknessControlsOn(a.uid),c=a.sWidth,s=a.sHeight,d=Math.sqrt(c*c+s*s),u=[.5*c,.5*s],v=a.canvasToWorld(u),m=[0,0,0];G().cross(g.viewPlaneNormal,o.viewPlaneNormal,m),G().normalize(m),G().multiplyScalar(m,d);var p=[0,0,0];G().add(v,m,p);var b=[0,0,0];G().subtract(v,m,b);var w=h.worldToCanvas(p),_=g.focalPoint,y=h.worldToCanvas(_),T=[y-.5*c,y+.5*c,y-.5*s,y+.5*s],I=h.worldToCanvas(v),S=N.vec2.create();N.vec2.subtract(S,w,I),N.vec2.normalize(S,S);var M=N.vec2.create();N.vec2.scale(M,S,100*E);var k=N.vec2.create();N.vec2.scale(k,S,.25*E);var x=N.vec2.create();N.vec2.scale(x,S,.15*E);var O=N.vec2.create();N.vec2.scale(O,S,.05*E);var L=N.vec2.create(),R=N.vec2.create(),A=N.vec2.create(),P=N.vec2.create(),V=N.vec2.clone(D);i&&r||(V=N.vec2.clone(I)),N.vec2.add(L,V,O),N.vec2.add(R,V,M),N.vec2.subtract(A,V,O),N.vec2.subtract(P,V,M),Ln(L,R,T),Ln(A,P,T);var B=N.vec2.create();N.vec2.subtract(B,D,k);var H=N.vec2.create();N.vec2.add(H,D,k);var j=N.vec2.clone(D);!i&&l&&(j=N.vec2.clone(I));var F=U(n.toolCenter);!i&&l&&(F=U(v));var W=[0,0,0];G().subtract(p,b,W),G().normalize(W);var z=g.viewPlaneNormal,q=Ot().buildFromDegree().rotate(90,z).matrix,K=[0,0,0];N.vec3.transformMat4(K,W,q);var Y=a.getSlabThickness(),X=[].concat(K);G().multiplyScalar(X,Y);var $=[0,0,0];G().add(F,X,$);var J=h.worldToCanvas($),Z=N.vec2.create();N.vec2.subtract(Z,j,J);var Q=N.vec2.create();N.vec2.subtract(Q,j,M),N.vec2.add(Q,Q,Z);var ee=N.vec2.create();N.vec2.add(ee,j,M),N.vec2.add(ee,ee,Z),Ln(Q,ee,T);var te=N.vec2.create();N.vec2.add(te,j,M),N.vec2.subtract(te,te,Z);var ne=N.vec2.create();N.vec2.subtract(ne,j,M),N.vec2.subtract(ne,ne,Z),Ln(te,ne,T);var ae=N.vec2.create(),oe=N.vec2.create(),re=N.vec2.create(),ie=N.vec2.create();N.vec2.subtract(ae,j,x),N.vec2.add(ae,ae,Z),N.vec2.add(oe,j,x),N.vec2.add(oe,oe,Z),N.vec2.subtract(re,j,x),N.vec2.subtract(re,re,Z),N.vec2.add(ie,j,x),N.vec2.subtract(ie,ie,Z),C.push([a,L,R,A,P,Q,ee,te,ne,B,H,ae,oe,re,ie])}));var T=[],I=[],S=this._getReferenceLineColor(h.uid),M=void 0!==S?S:"rgb(200, 200, 200)";C.forEach((function(e,a){var o=e[0],r=n._getReferenceLineColor(o.uid),i=n._getReferenceLineControllable(o.uid),l=n._getReferenceLineDraggableRotatable(o.uid),c=n._getReferenceLineSlabThicknessControlsOn(o.uid),s=_.activeViewportUIDs.find((function(e){return e===o.uid})),d=void 0!==r?r:"rgb(200, 200, 200)",u=1,v=null!==_.handles.activeOperation&&1===_.handles.activeOperation&&s;v&&(u=2.5);var f="".concat(a);if(i&&l?(f="".concat(a,"One"),ke(t,n.name,p,f,e[1],e[2],{color:d,width:u}),f="".concat(a,"Two"),ke(t,n.name,p,f,e[3],e[4],{color:d,width:u})):ke(t,n.name,p,f,e[2],e[4],{color:d,width:u}),i){d=void 0!==r?r:"rgb(200, 200, 200)";var g=2===_.handles.activeOperation,m=[e[9],e[10]],b=[h.canvasToWorld(e[9]),o,e[1],e[2]],w=[h.canvasToWorld(e[10]),o,e[3],e[4]];T.push(b,w);var E=3===_.handles.activeOperation,D=[e[11],e[12],e[13],e[14]],y=[h.canvasToWorld(e[11]),o,e[5],e[6]],C=[h.canvasToWorld(e[12]),o,e[5],e[6]],U=[h.canvasToWorld(e[13]),o,e[7],e[8]],S=[h.canvasToWorld(e[14]),o,e[7],e[8]];if(I.push(y,C,U,S),v&&!g&&!E&&l&&c){var M="".concat(a,"One");Me(t,n.name,p,M,m,{color:d,handleRadius:3,type:"circle"}),M="".concat(a,"Two"),Me(t,n.name,p,M,D,{color:d,handleRadius:3,type:"rect"})}else if(v&&!g&&!E&&l){var k="".concat(a);Me(t,n.name,p,k,m,{color:d,handleRadius:3,type:"circle"})}else if(s&&!g&&!E&&c){var x="".concat(a);Me(t,n.name,p,x,D,{color:d,handleRadius:3,type:"rect"})}else if(g&&l){var O="".concat(a);Me(t,n.name,p,O,m,{color:d,handleRadius:2,fill:d,type:"circle"})}else E&&s&&c&&Me(t,n.name,p,f,D,{color:d,handleRadius:2,fill:d,type:"rect"});o.getSlabThickness()>.5&&c&&(f="".concat(a,"STOne"),ke(t,n.name,p,f,e[5],e[6],{color:d,width:1,lineDash:[2,3]}),f="".concat(a,"STTwo"),ke(t,n.name,p,f,e[7],e[8],{color:d,width:e,lineDash:[2,3]}))}})),_.handles.rotationPoints=T,_.handles.slabThicknessPoints=I;var k=[.95*b,.05*w],x=.01*E;!function(e,t,n,a,o,r){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=Object.assign({},{color:"dodgerblue",fill:"transparent",width:2},i),c=l.color,s=l.fill,d=l.width,u="http://www.w3.org/2000/svg",v=Ie(t,n,"circle",a),f=e._getSvgNode(v);if(f)f.setAttribute("cx","".concat(o[0])),f.setAttribute("cy","".concat(o[1])),f.setAttribute("r","".concat(r)),f.setAttribute("stroke",c),f.setAttribute("fill",s),f.setAttribute("stroke-width","".concat(d)),e._setNodeTouched(v);else{var h=document.createElementNS(u,"circle");h.setAttribute("cx","".concat(o[0])),h.setAttribute("cy","".concat(o[1])),h.setAttribute("r","".concat(r)),h.setAttribute("stroke",c),h.setAttribute("fill",s),h.setAttribute("stroke-width","".concat(d)),e._appendNode(h,v)}}(t,this.name,p,"0",k,x,{color:M,fill:M})}}}},{key:"_activateModify",value:function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,this._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(X.TOUCH_END,this._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"_deactivateModify",value:function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(X.TOUCH_END,this._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"_mouseUpCallback",value:function(e){var t=e.detail.element;this.editData.toolData.data.active=!1,this.editData.toolData.data.handles.activeOperation=null,this.editData.toolData.data.activeViewportUIDs=[],this._deactivateModify(t),kn(t),this.editData=null;var n=(0,s.getEnabledElement)(t).renderingEngine,a=It(t,this.name);n.renderViewports(a)}},{key:"_mouseDragCallback",value:function(e){var t=this,n=e.detail,a=n.deltaPoints.world;if(!(Math.abs(a[0])<.001&&Math.abs(a[1])<.001&&Math.abs(a[2])<.001)){var o=n.element,r=(0,s.getEnabledElement)(o),i=r.renderingEngine,l=r.viewport,c=Kt(r,this.name),d=this.filterInteractableToolStateForElement(o,c)[0];if(d){var u=d.data.handles,v=e.detail.currentPoints.canvas;if(1===u.activeOperation){var f=this._filterViewportOrientations(r,c).filter((function(e){var t=e.data,n=i.getScene(t.sceneUID).getViewport(t.viewportUID);return d.data.activeViewportUIDs.find((function(e){return e===n.uid}))}));this._applyDeltaShiftToSelectedViewportCameras(i,f,a)}else if(2===u.activeOperation){var h=this._filterViewportOrientations(r,c),g=i.getScene(d.data.sceneUID),m=h.filter((function(e){var n=e.data,a=i.getScene(n.sceneUID),o=a.getViewport(n.viewportUID),r=t._getReferenceLineControllable(o.uid),l=t._getReferenceLineDraggableRotatable(o.uid);return g===a&&!0===r&&!0===l})),p=N.vec2.create(),b=N.vec2.create(),w=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],E=l.worldToCanvas(w),_=n.currentPoints.canvas,D=N.vec2.create();N.vec2.sub(D,_,n.deltaPoints.canvas),N.vec2.sub(p,D,E),N.vec2.sub(b,_,E);var y=N.vec2.angle(p,b);this._isClockWise(E,D,_)&&(y*=-1);var C=l.getCamera().viewPlaneNormal,T=Ot().buildFromRadian().translate(w[0],w[1],w[2]).rotate(y,C).translate(-w[0],-w[1],-w[2]).matrix;m.forEach((function(e){var t=e.data,n=i.getScene(t.sceneUID).getViewport(t.viewportUID),a=n.getCamera(),o=a.viewUp,r=a.position,l=a.focalPoint;o[0]+=r[0],o[1]+=r[1],o[2]+=r[2],N.vec3.transformMat4(l,l,T),N.vec3.transformMat4(r,r,T),N.vec3.transformMat4(o,o,T),o[0]-=r[0],o[1]-=r[1],o[2]-=r[2],n.setCamera({position:r,viewUp:o,focalPoint:l})}))}else 3===u.activeOperation&&c.filter((function(e){var t=e.data,n=i.getScene(t.sceneUID).getViewport(t.viewportUID);return d.data.activeViewportUIDs.find((function(e){return e===n.uid}))})).forEach((function(e){var o=e.data,r=i.getScene(o.sceneUID).getViewport(o.viewportUID),c=r.getCamera().viewPlaneNormal,s=G().dot(a,c),u=U(c);if(G().multiplyScalar(u,s),Math.abs(u[0])>.001||Math.abs(u[1])>.001||Math.abs(u[2])>.001){var f=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),h=n.lastPoints.world,g=[0,0,0],m=[t.toolCenter[0],t.toolCenter[1],t.toolCenter[2]];if(!t._getReferenceLineDraggableRotatable(r.uid)){var p=t.editData.toolData.data.handles.rotationPoints.filter((function(e){return e[1].uid===r.uid}));if(2===p.length){var b=l.canvasToWorld(p[0][3]),w=l.canvasToWorld(p[1][3]);G().add(b,w,m),G().multiplyScalar(m,.5)}}G().subtract(h,m,g);var E=G().dot(g,c),_=U(c);G().multiplyScalar(_,E);var D=[_[0],_[1],_[2]];N.vec3.normalize(D,D);var y=[u[0],u[1],u[2]];N.vec3.normalize(y,y);var C=r.getSlabThickness();Pn(D,y,.001)?C-=f:C+=f,C=Math.abs(C),C=Math.max(.1,C),t._pointNearReferenceLine(d,v,6,r)?r.setSlabThickness(null):r.setSlabThickness(C)}}))}}}},{key:"_isClockWise",value:function(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}},{key:"_applyDeltaShiftToSelectedViewportCameras",value:function(e,t,n){var a=this;t.forEach((function(t){a._applyDeltaShiftToViewportCamera(e,t,n)}))}},{key:"_applyDeltaShiftToViewportCamera",value:function(e,t,n){var a=t.data,o=e.getScene(a.sceneUID).getViewport(a.viewportUID),r=o.getCamera(),i=r.viewPlaneNormal,l=G().dot(n,i),c=U(i);if(G().multiplyScalar(c,l),Math.abs(c[0])>.001||Math.abs(c[1])>.001||Math.abs(c[2])>.001){var s=[0,0,0],d=[0,0,0];G().add(r.focalPoint,c,s),G().add(r.position,c,d),o.setCamera({focalPoint:s,position:d})}}},{key:"_getRotationHandleNearImagePoint",value:function(e,t,n,a){for(var o=t.data,r=o.handles.rotationPoints,i=0;i<r.length;i++){var l=r[i][0],c=r[i][1];if(this._getReferenceLineControllable(c.uid)&&this._getReferenceLineDraggableRotatable(c.uid)){var s=e.worldToCanvas(l);if(N.vec2.distance(n,s)<a)return o.handles.activeOperation=2,this.editData={toolData:t},l}}return null}},{key:"_getSlabThicknessHandleNearImagePoint",value:function(e,t,n,a){for(var o=t.data,r=o.handles.slabThicknessPoints,i=0;i<r.length;i++){var l=r[i][0],c=r[i][1];if(this._getReferenceLineControllable(c.uid)&&this._getReferenceLineSlabThicknessControlsOn(c.uid)){var s=e.worldToCanvas(l);if(N.vec2.distance(n,s)<a)return o.handles.activeOperation=3,o.activeViewportUIDs=[c.uid],this.editData={toolData:t},l}}return null}},{key:"_pointNearTool",value:function(e,t,n,a){for(var o=this,r=(0,s.getEnabledElement)(e).viewport,i=r.sWidth,l=r.sHeight,c=Math.sqrt(i*i+l*l),d=t.data,u=d.handles.rotationPoints,v=d.handles.slabThicknessPoints,f=[],h=0;h<u.length-1;++h){var g=u[h][1],m=this._getReferenceLineControllable(g.uid),p=this._getReferenceLineDraggableRotatable(g.uid);if(m&&p){var b={start:{x:u[h][2][0],y:u[h][2][1]},end:{x:u[h][3][0],y:u[h][3][1]}},w=A.distanceToPoint([b.start.x,b.start.y],[b.end.x,b.end.y],[n[0],n[1]]),E={start:{x:u[h+1][2][0],y:u[h+1][2][1]},end:{x:u[h+1][3][0],y:u[h+1][3][1]}},_=A.distanceToPoint([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(w<=a||_<=a)&&(f.push(g.uid),d.handles.activeOperation=1),h++}}for(var D=function(e){var t=v[e][1];if(f.find((function(e){return e===t.uid})))return y=e,"continue";var r=o._getReferenceLineControllable(t.uid),i=o._getReferenceLineSlabThicknessControlsOn(t.uid);if(!r||!i)return y=e,"continue";var l=v[e][2],s=v[e][3],u=N.vec2.create();N.vec2.add(u,l,s),N.vec2.scale(u,u,.5);var h=N.vec2.create();N.vec2.subtract(h,l,u),N.vec2.normalize(h,h);var g=N.vec2.create();N.vec2.scale(g,h,.05*c);var m=N.vec2.create(),p=N.vec2.create();N.vec2.add(m,u,g),N.vec2.subtract(p,u,g);var b={start:{x:m[0],y:m[1]},end:{x:l[0],y:l[1]}},w=A.distanceToPoint([b.start.x,b.start.y],[b.end.x,b.end.y],[n[0],n[1]]),E={start:{x:p[0],y:p[1]},end:{x:s[0],y:s[1]}},_=A.distanceToPoint([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(w<=a||_<=a)&&(f.push(t.uid),d.handles.activeOperation=null),e++,y=e},y=0;y<v.length-1;++y)D(y);return d.activeViewportUIDs=[].concat(f),this.editData={toolData:t},1===d.handles.activeOperation}}]),l}(wn);var Fn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"MIPJumpToClickTool",supportedInteractionTypes:["Mouse","Touch"],configuration:{}})),"_configuration",void 0),a(hn(t),"_bounds",void 0),a(hn(t),"_getTargetVolumeUID",(function(e){if(t.configuration.volumeUID)return t.configuration.volumeUID;var n=e.getVolumeActors();return n||n.length?n[0].uid:void 0})),t}return n(l,[{key:"mouseClickCallback",value:function(e){var t=e.detail,n=t.element,a=t.currentPoints,o=t.renderingEngineUID,r=t.sceneUID,i=(0,s.getEnabledElement)(n),l=i.viewport,c=i.scene,d=i.renderingEngine,u=this._getTargetVolumeUID(c),v=-1/0,f=function(e,t,n,a,o){var r,i=t.getCamera(),l=i.position,c=H(e,i,n).spacingInNormalDirection/4,s=t.getBounds(),d=s[0],u=s[1],v=[0,0,0],f=[0,0,0];G().subtract(o,l,v);for(var h=d;h<=u;h+=c){f=[h,0,0];var g=(h-l[0])/v[0];if(f[1]=g*v[1]+l[1],f[2]=g*v[2]+l[2],q(f,s)){var m=a(t.getIntensityFromWorld(f),f);m&&(r=m)}}return r}(c,l,u,(function(e,t){if(e>v)return v=e,t}),a.world);f&&f.length&&d.getScenesContainingVolume(u).forEach((function(e){e.uid!==r&&e.getViewports().forEach((function(t){bt.getToolGroups(o,e.uid,t.uid).forEach((function(n){var a=n.getToolInstance("Crosshairs");if(a&&a instanceof jn){var o={viewport:t,scene:e,renderingEngine:d,viewportUID:t.uid,sceneUID:r,renderingEngineUID:d.uid,FrameOfReferenceUID:t.getFrameOfReferenceUID()};a.jumpToWorld(o,f)}}))}))}))}}]),l}(fn);var Wn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"Bidirectional",supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0}})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_throttledCalculateCachedStats",void 0),a(hn(t),"editData",void 0),a(hn(t),"_configuration",void 0),a(hn(t),"addNewMeasurement",(function(e,n){var a=e.detail,o=a.currentPoints,r=a.element,i=o.world,l=(0,s.getEnabledElement)(r),c=l.viewport,d=l.FrameOfReferenceUID,u=l.renderingEngine;if(d){var v=c.getCamera(),f=v.viewPlaneNormal,h=v.viewUp,g={metadata:{viewPlaneNormal:U(f),viewUp:U(h),FrameOfReferenceUID:d,toolName:t.name},data:{invalidated:!0,handles:{points:[U(i),U(i),U(i),U(i)],textBox:{hasMoved:!1,worldPosition:[0,0,0]},activeHandleIndex:null},cachedStats:{},active:!0}};Yt(0,g);var m=It(r,t.name);t.editData={toolData:g,viewportUIDsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},t._activateDraw(r),xn(r),e.preventDefault(),u.renderViewports(m)}else console.warn("No FrameOfReferenceUID, empty scene, exiting early.")})),a(hn(t),"getHandleNearImagePoint",(function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=t.data,i=r.handles,l=i.points,c=i.textBox,d=c.worldBoundingBox;if(d){var u={topLeft:o.worldToCanvas(d.topLeft),topRight:o.worldToCanvas(d.topRight),bottomLeft:o.worldToCanvas(d.bottomLeft),bottmRight:o.worldToCanvas(d.bottomRight)};if(n[0]>=u.topLeft[0]&&n[0]<=u.bottmRight[0]&&n[1]>=u.topLeft[1]&&n[1]<=u.bottmRight[1])return r.handles.activeHandleIndex=null,c}for(var v=0;v<l.length;v++){var f=l[v],h=o.worldToCanvas(f);if(!0==N.vec2.distance(n,h)<a)return r.handles.activeHandleIndex=v,f}r.handles.activeHandleIndex=null})),a(hn(t),"pointNearTool",(function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=t.data.handles.points,i=o.worldToCanvas(r[0]),l=o.worldToCanvas(r[1]),c={start:{x:i[0],y:i[1]},end:{x:l[0],y:l[1]}},d=A.distanceToPoint([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return d<=a||(i=o.worldToCanvas(r[2]),l=o.worldToCanvas(r[3]),c={start:{x:i[0],y:i[1]},end:{x:l[0],y:l[1]}},(d=A.distanceToPoint([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]))<=a||void 0)})),a(hn(t),"toolSelectedCallback",(function(e,n){var a=e.detail.element;n.data.active=!0;var o=It(a,t.name);t.editData={toolData:n,viewportUIDsToRender:o,movingTextBox:!1},t._activateModify(a),(0,s.getEnabledElement)(a).renderingEngine.renderViewports(o),xn(a),e.preventDefault()})),a(hn(t),"handleSelectedCallback",(function(e,n,a){var o=e.detail.element,r=n.data;r.active=!0;var i,l=!1;a.worldPosition?l=!0:i=r.handles.points.findIndex((function(e){return e===a}));var c=It(o,t.name);xn(o),t.editData={toolData:n,viewportUIDsToRender:c,handleIndex:i,movingTextBox:l},t._activateModify(o),(0,s.getEnabledElement)(o).renderingEngine.renderViewports(c),e.preventDefault()})),a(hn(t),"_mouseUpCallback",(function(e){var n=e.detail.element,a=t.editData,o=a.toolData,r=a.viewportUIDsToRender,i=a.newAnnotation,l=a.hasMoved,c=o.data;if(!i||l){c.active=!1,c.handles.activeHandleIndex=null,t._deactivateModify(n),t._deactivateDraw(n),kn(n);var d=(0,s.getEnabledElement)(n).renderingEngine;if(void 0!==t.editData.handleIndex){var u=c.handles.points,v=N.vec3.distance(u[0],u[1]);if(N.vec3.distance(u[2],u[3])>v){var f=[U(u[2]),U(u[3])],h=U(u[0]),g=U(u[1]),m=N.vec2.create();N.vec2.set(m,f[1][0]-f[0][0],f[1][1]-f[1][0]);var p=N.vec2.create();N.vec2.set(p,-m[1],m[0]);var b,w=N.vec2.create();N.vec2.set(w,g[0]-h[0],g[1]-h[0]),b=N.vec2.dot(w,p)>0?[h,g]:[g,h],c.handles.points=[f[0],f[1],b[0],b[1]]}}t.editData=null,d.renderViewports(r)}})),a(hn(t),"_mouseDragDrawCallback",(function(e){var n=e.detail,a=n.currentPoints,o=n.element,r=(0,s.getEnabledElement)(o),i=r.renderingEngine,l=r.viewport,c=l.worldToCanvas,d=t.editData,u=d.toolData,v=d.viewportUIDsToRender,f=d.handleIndex,h=u.data,g=a.world;h.handles.points[f]=U(g);var m=h.handles.points.map(c),p={x:m[0][0],y:m[0][1]},b={x:m[1][0],y:m[1][1]},w=(m[2][0],m[2][1],m[3][0],m[3][1],N.vec2.distance(m[0],m[1])/3),E=p.x-b.x,_=p.y-b.y,D=Math.sqrt(E*E+_*_),y=E/D,C=_/D,T=(p.x+b.x)/2,I=(p.y+b.y)/2,S=T+w*C,M=I-w*y,k=T-w*C,x=I+w*y;h.handles.points[2]=l.canvasToWorld([S,M]),h.handles.points[3]=l.canvasToWorld([k,x]),h.invalidated=!0,i.renderViewports(v),t.editData.hasMoved=!0})),a(hn(t),"_mouseDragModifyCallback",(function(e){var n=e.detail,a=n.element,o=(0,s.getEnabledElement)(a).renderingEngine,r=t.editData,i=r.toolData,l=r.viewportUIDsToRender,c=r.handleIndex,d=r.movingTextBox,u=i.data;if(d){var v=n.deltaPoints.world,f=u.handles.textBox,h=f.worldPosition;h[0]+=v[0],h[1]+=v[1],h[2]+=v[2],f.hasMoved=!0}else if(void 0===c){var g=n.deltaPoints.world;u.handles.points.forEach((function(e){e[0]+=g[0],e[1]+=g[1],e[2]+=g[2]}))}else t._mouseDragModifyHandle(e);u.invalidated=!0,o.renderViewports(l)})),a(hn(t),"_mouseDragModifyHandle",(function(e){var n=e.detail,a=n.currentPoints,o=n.element,r=(0,s.getEnabledElement)(o).viewport,i=t.editData,l=i.toolData,c=i.handleIndex,d=l.data,u=a.world,v=[r.worldToCanvas(d.handles.points[0]),r.worldToCanvas(d.handles.points[1]),r.worldToCanvas(d.handles.points[2]),r.worldToCanvas(d.handles.points[3])],f={start:{x:v[0][0],y:v[0][1]},end:{x:v[1][0],y:v[1][1]}},h={start:{x:v[2][0],y:v[2][1]},end:{x:v[3][0],y:v[3][1]}},g=U(u),m=r.worldToCanvas(g);if(0===c||1===c){var p=v[0===c?1:0],b={start:{x:p[0],y:p[1]},end:{x:m[0],y:m[1]}};if(t._movingLongAxisWouldPutItThroughShortAxis(b,h))return;var w=A.intersectLine([h.start.x,h.start.y],[h.end.x,h.end.y],[f.start.x,f.start.y],[f.end.x,f.end.y]),E=N.vec2.create();N.vec2.set(E,w[0],w[1]);var _=N.vec2.distance(v[2],E),D=N.vec2.distance(v[3],E),y=Math.abs(N.vec2.distance(p,E)),C=p[0]-m[0],T=p[1]-m[1],I=Math.sqrt(C*C+T*T),S=C/I,M=T/I,k=p[0]-y*S,x=p[1]-y*M,O=0===c?-1:1,L=k+_*M*O,R=x-_*S*O,P=k-D*M*O,V=x+D*S*O;d.handles.points[c]=g,d.handles.points[2]=r.canvasToWorld([L,R]),d.handles.points[3]=r.canvasToWorld([P,V])}else{var B=2===c?3:2,H={x:m[0],y:m[1]},j={longLineSegment:{start:f.start,end:f.end},shortLineSegment:{start:h.start,end:h.end}},F=j.longLineSegment.start.x-j.longLineSegment.end.x,W=j.longLineSegment.start.y-j.longLineSegment.end.y,G=Math.sqrt(F*F+W*W),z=F/G,q=W/G,K=(0===c||3===c?1:-1)*Number.MAX_SAFE_INTEGER,Y={start:H,end:{x:H.x+q*K,y:H.y+z*K*-1}},X=A.intersectLine([j.longLineSegment.start.x,j.longLineSegment.start.y],[j.longLineSegment.end.x,j.longLineSegment.end.y],[Y.start.x,Y.start.y],[Y.end.x,Y.end.y]);if(void 0===X)return;var $=N.vec2.distance(v[B],[X[0],X[1]]),J={start:{x:X[0]+q*$,y:X[1]+z*$*-1},end:{x:X[0]+q*$*-1,y:X[1]+z*$}},Z=2===B?J.start:J.end;d.handles.points[B]=r.canvasToWorld([Z.x,Z.y]),d.handles.points[c]=g}})),a(hn(t),"_movingLongAxisWouldPutItThroughShortAxis",(function(e,t){var n=N.vec2.create();N.vec2.set(n,t.end.x-t.start.x,t.end.y-t.start.y),N.vec2.normalize(n,n);var a={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!A.intersectLine([a.start.x,a.start.y],[a.end.x,a.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])})),a(hn(t),"_activateDraw",(function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,t._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,t._mouseDragDrawCallback),e.addEventListener(X.MOUSE_MOVE,t._mouseDragDrawCallback),e.addEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.addEventListener(X.TOUCH_END,t._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,t._mouseDragDrawCallback)})),a(hn(t),"_deactivateDraw",(function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,t._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,t._mouseDragDrawCallback),e.removeEventListener(X.MOUSE_MOVE,t._mouseDragDrawCallback),e.removeEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.removeEventListener(X.TOUCH_END,t._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,t._mouseDragDrawCallback)})),a(hn(t),"_activateModify",(function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,t._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,t._mouseDragModifyCallback),e.addEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.addEventListener(X.TOUCH_END,t._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,t._mouseDragModifyCallback)})),a(hn(t),"_deactivateModify",(function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,t._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,t._mouseDragModifyCallback),e.removeEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.removeEventListener(X.TOUCH_END,t._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,t._mouseDragModifyCallback)})),a(hn(t),"filterInteractableToolStateForElement",(function(e,t){if(t&&t.length){var n=(0,s.getEnabledElement)(e),a=n.viewport,o=n.scene,r=a.getCamera();return j(t,r,H(o,r).spacingInNormalDirection)}})),a(hn(t),"_getTextLines",(function(e){var t=e.cachedStats,n=t.length,a=t.width;if(void 0!==n)return["L: ".concat(n.toFixed(2)," mm"),"W: ".concat(a.toFixed(2)," mm")]})),a(hn(t),"_calculateCachedStats",(function(e){var t=e.handles.points[0],n=e.handles.points[1],a=e.handles.points[2],o=e.handles.points[3],r=Math.sqrt(G().distance2BetweenPoints(t,n)),i=Math.sqrt(G().distance2BetweenPoints(a,o)),l=r>i?r:i,c=r>i?i:r;e.cachedStats={length:l,width:c},e.invalidated=!1})),a(hn(t),"_isInsideVolume",(function(e,t,n){return St(e,n)&&St(t,n)})),a(hn(t),"_clipIndexToVolume",(function(e,t){for(var n=0;n<=2;n++)e[n]<0?e[n]=0:e[n]>=t[n]&&(e[n]=t[n]-1)})),a(hn(t),"_getTargetVolumeUID",(function(e){if(t.configuration.volumeUID)return t.configuration.volumeUID;var n=e.getVolumeActors();return n||n.length?n[0].uid:void 0})),t._throttledCalculateCachedStats=Gt(t._calculateCachedStats,100,{trailing:!0}),t}return n(l,[{key:"renderToolData",value:function(e,t){var n=e.detail.canvas,a=Kt(t.enabledElement,this.name);if(a&&(a=this.filterInteractableToolStateForElement(n,a)).length)for(var o=t.enabledElement.viewport,r=(D.getToolWidth(),0);r<a.length;r++){var i=a[r],l=i.metadata.toolUID,c=i.data,s=c.handles,d=s.points,u=s.activeHandleIndex,v=w.getColorIfActive(c),f=d.map((function(e){return o.worldToCanvas(e)}));c.invalidated&&this._throttledCalculateCachedStats(c);var h=void 0;this.editData||null===u||(h=[f[u]]),h&&Me(t,this.name,l,"0",h,{color:v}),ke(t,this.name,l,"0",f[0],f[1],{color:v}),ke(t,this.name,l,"1",f[2],f[3],{color:v});var g=this._getTextLines(c);if(g&&0!==g.length){var m=void 0;c.handles.textBox.hasMoved||(m=Mt(f),c.handles.textBox.worldPosition=o.canvasToWorld(m));var p=o.worldToCanvas(c.handles.textBox.worldPosition),b=Pe(t,this.name,l,"1",g,p,f,{},{color:v}),E=b.x,_=b.y,y=b.width,C=b.height;c.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([E,_]),topRight:o.canvasToWorld([E+y,_]),bottomLeft:o.canvasToWorld([E,_+C]),bottomRight:o.canvasToWorld([E+y,_+C])}}}}}]),l}(wn);var Gn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"Length",supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0}})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_throttledCalculateCachedStats",void 0),a(hn(t),"editData",void 0),a(hn(t),"_configuration",void 0),t._activateModify=t._activateModify.bind(hn(t)),t._deactivateModify=t._deactivateModify.bind(hn(t)),t._mouseUpCallback=t._mouseUpCallback.bind(hn(t)),t._mouseDragCallback=t._mouseDragCallback.bind(hn(t)),t._throttledCalculateCachedStats=Gt(t._calculateCachedStats,100,{trailing:!0}),t}return n(l,[{key:"addNewMeasurement",value:function(e,t){var n=e.detail,a=n.currentPoints,o=n.element,r=a.world,i=(0,s.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;xn(o);var d,u=l.getCamera(),v=u.viewPlaneNormal,f=u.viewUp;if(l instanceof s.StackViewport)d=l.getCurrentImageId&&l.getCurrentImageId();else{var h=this.configuration.volumeUID;d=function(e,t,n,a){var o=a.direction,r=a.imageIds,i=o.slice(6,9),l=N.vec3.dot(i,t);if(!(Math.abs(l)<.99)){for(var c,d=B(a,t)/2,u=0;u<r.length;u++){var v=r[u],f=s.metaData.get("imagePlaneModule",v).imagePositionPatient,h=N.vec3.create();N.vec3.sub(h,e,f);var g=N.vec3.dot(h,t);Math.abs(g)<d&&(c=v)}return c}}(r,v,0,(0,s.getVolume)(h))}if(d){var g=d.indexOf(":");d=d.substring(g+1)}var m={metadata:{viewPlaneNormal:U(v),viewUp:U(f),FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:d,toolName:this.name},data:{invalidated:!0,handles:{points:[U(r),U(r)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0]}},cachedStats:{},active:!0}};Yt(0,m);var p=It(o,this.name);this.editData={toolData:m,viewportUIDsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),c.renderViewports(p)}},{key:"getHandleNearImagePoint",value:function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=t.data,i=r.handles,l=i.points,c=i.textBox,d=c.worldBoundingBox;if(d){var u={topLeft:o.worldToCanvas(d.topLeft),topRight:o.worldToCanvas(d.topRight),bottomLeft:o.worldToCanvas(d.bottomLeft),bottomRight:o.worldToCanvas(d.bottomRight)};if(n[0]>=u.topLeft[0]&&n[0]<=u.bottomRight[0]&&n[1]>=u.topLeft[1]&&n[1]<=u.bottomRight[1])return r.handles.activeHandleIndex=null,c}for(var v=0;v<l.length;v++){var f=l[v],h=o.worldToCanvas(f);if(!0==N.vec2.distance(n,h)<a)return r.handles.activeHandleIndex=v,f}r.handles.activeHandleIndex=null}},{key:"pointNearTool",value:function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=T(t.data.handles.points,2),i=r[0],l=r[1],c=o.worldToCanvas(i),d=o.worldToCanvas(l),u={start:{x:c[0],y:c[1]},end:{x:d[0],y:d[1]}};if(A.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=a)return!0}},{key:"toolSelectedCallback",value:function(e,t){var n=e.detail.element;t.data.active=!0;var a=It(n,this.name);this.editData={toolData:t,viewportUIDsToRender:a,movingTextBox:!1},this._activateModify(n),xn(n),(0,s.getEnabledElement)(n).renderingEngine.renderViewports(a),e.preventDefault()}},{key:"handleSelectedCallback",value:function(e,t,n){var a=e.detail.element,o=t.data;o.active=!0;var r,i=!1;n.worldPosition?i=!0:r=o.handles.points.findIndex((function(e){return e===n}));var l=It(a,this.name);this.editData={toolData:t,viewportUIDsToRender:l,handleIndex:r,movingTextBox:i},this._activateModify(a),xn(a),(0,s.getEnabledElement)(a).renderingEngine.renderViewports(l),e.preventDefault()}},{key:"_mouseUpCallback",value:function(e){var t=e.detail.element,n=this.editData,a=n.toolData,o=n.viewportUIDsToRender,r=n.newAnnotation,i=n.hasMoved,l=a.data;r&&!i||(l.active=!1,l.handles.activeHandleIndex=null,this._deactivateModify(t),this._deactivateDraw(t),kn(t),(0,s.getEnabledElement)(t).renderingEngine.renderViewports(o),this.editData=null)}},{key:"_mouseDragCallback",value:function(e){var t=e.detail,n=t.element,a=this.editData,o=a.toolData,r=a.viewportUIDsToRender,i=a.handleIndex,l=a.movingTextBox,c=o.data;if(l){var d=t.deltaPoints.world,u=c.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===i){var f=t.deltaPoints.world;c.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]}))}else{var h=t.currentPoints.world;c.handles.points[i]=U(h)}c.invalidated=!0,this.editData.hasMoved=!0,(0,s.getEnabledElement)(n).renderingEngine.renderViewports(r)}},{key:"_activateModify",value:function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,this._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(X.TOUCH_END,this._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"_deactivateModify",value:function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(X.TOUCH_END,this._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"_activateDraw",value:function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,this._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(X.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(X.TOUCH_END,this._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"_deactivateDraw",value:function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(X.MOUSE_MOVE,this._mouseDragCallback),e.removeEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(X.TOUCH_END,this._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"filterInteractableToolStateForElement",value:function(e,t){if(t&&t.length)return function(e,t){if(e instanceof s.StackViewport){var n=e.getCurrentImageId(),a=n.indexOf(":");return n=n.substring(a+1),t.filter((function(e){return e.metadata.referencedImageId===n}))}if(e instanceof s.VolumeViewport){var o=e.getScene(),r=e.getCamera();return j(t,r,H(o,r).spacingInNormalDirection)}throw new Error("Viewport Type ".concat(e.type," not supported"))}((0,s.getEnabledElement)(e).viewport,t)}},{key:"renderToolData",value:function(e,t){var n=e.detail.canvas,a=Kt(t.enabledElement,this.name);if(a&&(a=this.filterInteractableToolStateForElement(n,a)).length){var o,r=t.enabledElement.viewport;if(r.type===s.VIEWPORT_TYPE.STACK)o="targetVolumeUID";else{if(r.type!==s.VIEWPORT_TYPE.ORTHOGRAPHIC)throw new Error("Viewport Type not supported: ".concat(r.type));var i=r.getScene();o=this._getTargetVolumeUID(i)}for(var l=D.getToolWidth(),c=0;c<a.length;c++){var d=a[c],u=d.metadata.toolUID,v=d.data,f=w.getColorIfActive(v),h=v.handles,g=h.points,m=h.activeHandleIndex,p=g.map((function(e){return r.worldToCanvas(e)})),b=void 0;this.editData||null===m||(b=[p[m]]),b&&Me(t,this.name,u,"0",p,{color:f}),ke(t,this.name,u,"1",p[0],p[1],{color:f,width:l}),v.cachedStats[o]?v.invalidated&&this._throttledCalculateCachedStats(v):(v.cachedStats[o]={},this._calculateCachedStats(v));var E=this._getTextLines(v,o);if(!v.handles.textBox.hasMoved){var _=Mt(p);v.handles.textBox.worldPosition=r.canvasToWorld(_)}var y=r.worldToCanvas(v.handles.textBox.worldPosition),C=Pe(t,this.name,u,"1",E,y,p,{},{color:f}),T=C.x,U=C.y,I=C.width,S=C.height;v.handles.textBox.worldBoundingBox={topLeft:r.canvasToWorld([T,U]),topRight:r.canvasToWorld([T+I,U]),bottomLeft:r.canvasToWorld([T,U+S]),bottomRight:r.canvasToWorld([T+I,U+S])}}}}},{key:"_findTextBoxAnchorPoints",value:function(e){return[e[0],e[1],[(e[0][0]+e[1][0])/2,(e[0][1]+e[1][1])/2]]}},{key:"_getTextLines",value:function(e,t){var n=e.cachedStats[t].length;if(void 0!==n)return["".concat(n.toFixed(2)," mm")]}},{key:"_calculateCachedStats",value:function(e){for(var t=e.handles.points[0],n=e.handles.points[1],a=e.cachedStats,o=Object.keys(a),r=0;r<o.length;r++){var i=o[r],l=Math.sqrt(G().distance2BetweenPoints(t,n));a[i]={length:l}}return e.invalidated=!1,a}},{key:"_isInsideVolume",value:function(e,t,n){return St(e,n)&&St(t,n)}},{key:"_clipIndexToVolume",value:function(e,t){for(var n=0;n<=2;n++)e[n]<0?e[n]=0:e[n]>=t[n]&&(e[n]=t[n]-1)}},{key:"_getTargetVolumeUID",value:function(e){if(this.configuration.volumeUID)return this.configuration.volumeUID;var t=e.getVolumeActors();return t||t.length?t[0].uid:void 0}}]),l}(wn);var zn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,l);var o={name:"Probe",supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0}};return a(hn(t=i.call(this,n,o)),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"editData",void 0),a(hn(t),"_configuration",void 0),t._activateModify=t._activateModify.bind(hn(t)),t._deactivateModify=t._deactivateModify.bind(hn(t)),t._mouseUpCallback=t._mouseUpCallback.bind(hn(t)),t._mouseDragCallback=t._mouseDragCallback.bind(hn(t)),t}return n(l,[{key:"pointNearTool",value:function(){}},{key:"toolSelectedCallback",value:function(){}},{key:"addNewMeasurement",value:function(e,t){var n,a=e.detail,o=a.currentPoints,r=a.element,i=o.world,l=(0,s.getEnabledElement)(r),c=l.viewport,d=l.renderingEngine,u=c.getCamera(),v=u.viewPlaneNormal,f=u.viewUp;c instanceof s.StackViewport&&(n=c.getCurrentImageId());var h={metadata:{viewPlaneNormal:U(v),viewUp:U(f),FrameOfReferenceUID:c.getFrameOfReferenceUID(),referencedImageId:n,toolName:this.name},data:{invalidated:!0,handles:{points:[U(i)]},cachedStats:{},active:!0}};Yt(0,h);var g=It(r,this.name);this.editData={toolData:h,viewportUIDsToRender:g},this._activateModify(r),xn(r),e.preventDefault(),d.renderViewports(g)}},{key:"getHandleNearImagePoint",value:function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=t.data.handles.points[0],i=o.worldToCanvas(r),l=N.vec2.distance(n,i)<a;return!0===l?r:l}},{key:"handleSelectedCallback",value:function(e,t,n){var a=e.detail.element;t.data.active=!0;var o=It(a,this.name);this.editData={toolData:t,viewportUIDsToRender:o},this._activateModify(a),xn(a),(0,s.getEnabledElement)(a).renderingEngine.renderViewports(o),e.preventDefault()}},{key:"_mouseUpCallback",value:function(e){var t=e.detail.element,n=this.editData,a=n.toolData,o=n.viewportUIDsToRender;a.data.active=!1,this._deactivateModify(t),kn(t),(0,s.getEnabledElement)(t).renderingEngine.renderViewports(o),this.editData=null}},{key:"_mouseDragCallback",value:function(e){var t=e.detail,n=t.currentPoints,a=t.element,o=n.world,r=this.editData,i=r.toolData,l=r.viewportUIDsToRender,c=i.data;c.handles.points[0]=U(o),c.invalidated=!0,(0,s.getEnabledElement)(a).renderingEngine.renderViewports(l)}},{key:"_activateModify",value:function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,this._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.addEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.addEventListener(X.TOUCH_END,this._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"_deactivateModify",value:function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,this._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,this._mouseDragCallback),e.removeEventListener(X.MOUSE_CLICK,this._mouseUpCallback),e.removeEventListener(X.TOUCH_END,this._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,this._mouseDragCallback)}},{key:"filterInteractableToolStateForElement",value:function(e,t){if(t&&t.length){var n=(0,s.getEnabledElement)(e),a=n.viewport,o=n.scene,r=a.getCamera();return j(t,r,H(o,r).spacingInNormalDirection)}}},{key:"renderToolData",value:function(e,t){var n=e.detail.canvas,a=Kt(t.enabledElement,this.name);if(a&&(a=this.filterInteractableToolStateForElement(n,a)).length)for(var o=t.enabledElement,r=o.viewport,i=o.scene,l=this._getTargetVolumeUID(i),c=0;c<a.length;c++){var s=a[c],d=s.metadata.toolUID,u=s.data,v=w.getColorIfActive(u),f=u.handles.points[0],h=r.worldToCanvas(f);u.cachedStats[l]?u.invalidated&&this._calculateCachedStats(u):(u.cachedStats[l]={},this._calculateCachedStats(u)),Me(t,this.name,d,"0",[h],{color:v});var g=this._getTextLines(u,l);if(g){var m=[h[0]+6,h[1]-6];Le(t,this.name,d,"0",g,[m[0],m[1]],{color:v})}}}},{key:"_getTextLines",value:function(e,t){var n=e.cachedStats[t],a=n.index,o=n.value,r=n.Modality;if(void 0!==o){var i=[];if(i.push("(".concat(a[0],", ").concat(a[1],", ").concat(a[2],")")),"PT"===r){var l=(0,s.getVolume)(t);if(l.scaling.PET&&(l.scaling.PET.suvbwToSuvbsa||l.scaling.PET.suvbwToSuvlbm)){var c=l.scaling.PET,d=c.suvbwToSuvlbm,u=c.suvbwToSuvbsa;if(i.push("".concat(o.toFixed(2)," SUV bw")),d){var v=o*d;i.push("".concat(v.toFixed(2)," SUV lbm"))}if(d){var f=o*u;i.push("".concat(f.toFixed(2)," SUV bsa"))}}else i.push("".concat(o.toFixed(2)," SUV"))}else"CT"===r?i.push("".concat(o.toFixed(2)," HU")):i.push("".concat(o.toFixed(2)," MO"));return i}}},{key:"_calculateCachedStats",value:function(e){for(var t=e.handles.points[0],n=e.cachedStats,a=Object.keys(n),o=0;o<a.length;o++){var r=a[o],i=(0,s.getVolume)(r),l=i.dimensions,c=i.scalarData,d=i.vtkImageData,u=i.metadata,v=[0,0,0];if(d.worldToIndexVec3(t,v),v[0]=Math.floor(v[0]),v[1]=Math.floor(v[1]),v[2]=Math.floor(v[2]),St(v,l)){var f=l[0],h=l[0]*l[1],g=c[v[2]*h+v[1]*f+v[0]];n[r]={index:v,value:g,Modality:u.Modality}}else n[r]={index:v,Modality:u.Modality}}e.invalidated=!1}},{key:"_getTargetVolumeUID",value:function(e){if(this.configuration.volumeUID)return this.configuration.volumeUID;var t=e.getVolumeActors();return t||t.length?t[0].uid:void 0}}]),l}(wn);var qn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"RectangleRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0}})),"_throttledCalculateCachedStats",void 0),a(hn(t),"editData",void 0),a(hn(t),"_configuration",void 0),a(hn(t),"addNewMeasurement",(function(e,n){var a=e.detail,o=a.currentPoints,r=a.element,i=o.world,l=(0,s.getEnabledElement)(r),c=l.viewport,d=l.FrameOfReferenceUID,u=l.renderingEngine;if(d){var v=c.getCamera(),f=v.viewPlaneNormal,h=v.viewUp,g={metadata:{viewPlaneNormal:U(f),viewUp:U(h),FrameOfReferenceUID:d,toolName:t.name},data:{invalidated:!0,handles:{points:[U(i),U(i),U(i),U(i)],textBox:{hasMoved:!1,worldPosition:[0,0,0]},activeHandleIndex:null},cachedStats:{},active:!0}};Yt(0,g);var m=It(r,t.name);t.editData={toolData:g,viewportUIDsToRender:m,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},t._activateDraw(r),xn(r),e.preventDefault(),u.renderViewports(m)}else console.warn("No FrameOfReferenceUID, empty scene, exiting early.")})),a(hn(t),"getHandleNearImagePoint",(function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=t.data,i=r.handles,l=i.points,c=i.textBox,d=c.worldBoundingBox;if(d){var u={topLeft:o.worldToCanvas(d.topLeft),topRight:o.worldToCanvas(d.topRight),bottomLeft:o.worldToCanvas(d.bottomLeft),bottmRight:o.worldToCanvas(d.bottomRight)};if(n[0]>=u.topLeft[0]&&n[0]<=u.bottmRight[0]&&n[1]>=u.topLeft[1]&&n[1]<=u.bottmRight[1])return r.handles.activeHandleIndex=null,c}for(var v=0;v<l.length;v++){var f=l[v],h=o.worldToCanvas(f);if(!0==N.vec2.distance(n,h)<a)return r.handles.activeHandleIndex=v,f}r.handles.activeHandleIndex=null})),a(hn(t),"pointNearTool",(function(e,n,a,o){var r=(0,s.getEnabledElement)(e).viewport,i=n.data.handles.points,l=r.worldToCanvas(i[0]),c=r.worldToCanvas(i[3]),d=t._getRectangleImageCoordinates([l,c]),u=[a[0],a[1]],v=d.left,f=d.top,h=d.width,g=d.height;if(P.distanceToPoint([v,f,h,g],u)<=o)return!0})),a(hn(t),"toolSelectedCallback",(function(e,n){var a=e.detail.element;n.data.active=!0;var o=It(a,t.name);t.editData={toolData:n,viewportUIDsToRender:o,movingTextBox:!1},t._activateModify(a),xn(a),(0,s.getEnabledElement)(a).renderingEngine.renderViewports(o),e.preventDefault()})),a(hn(t),"handleSelectedCallback",(function(e,n,a){var o=e.detail.element,r=n.data;r.active=!0;var i,l=!1;a.worldPosition?l=!0:i=r.handles.points.findIndex((function(e){return e===a}));var c=It(o,t.name);t.editData={toolData:n,viewportUIDsToRender:c,handleIndex:i,movingTextBox:l},t._activateModify(o),xn(o),(0,s.getEnabledElement)(o).renderingEngine.renderViewports(c),e.preventDefault()})),a(hn(t),"_mouseUpCallback",(function(e){var n=e.detail.element,a=t.editData,o=a.toolData,r=a.viewportUIDsToRender,i=a.newAnnotation,l=a.hasMoved,c=o.data;i&&!l||(c.active=!1,c.handles.activeHandleIndex=null,t._deactivateModify(n),t._deactivateDraw(n),kn(n),(0,s.getEnabledElement)(n).renderingEngine.renderViewports(r),t.editData=null)})),a(hn(t),"_mouseDragCallback",(function(e){var n=e.detail,a=n.element,o=t.editData,r=o.toolData,i=o.viewportUIDsToRender,l=o.handleIndex,c=o.movingTextBox,d=r.data;if(c){var u=n.deltaPoints.world,v=d.handles.textBox,f=v.worldPosition;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],v.hasMoved=!0}else if(void 0===l){var h=n.deltaPoints.world;d.handles.points.forEach((function(e){e[0]+=h[0],e[1]+=h[1],e[2]+=h[2]}))}else{var g,m,p,b,w,E,_,D,y=n.currentPoints,C=(0,s.getEnabledElement)(a).viewport,T=C.worldToCanvas,I=C.canvasToWorld,S=y.world,M=d.handles.points;switch(M[l]=U(S),l){case 0:case 3:g=T(M[0]),m=[(b=T(M[3]))[0],g[1]],p=[g[0],b[1]],E=I(m),_=I(p),M[1]=E,M[2]=_;break;case 1:case 2:m=T(M[1]),g=[(p=T(M[2]))[0],m[1]],b=[m[0],p[1]],w=I(g),D=I(b),M[0]=w,M[3]=D}}d.invalidated=!0,t.editData.hasMoved=!0,(0,s.getEnabledElement)(a).renderingEngine.renderViewports(i)})),a(hn(t),"_activateDraw",(function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,t._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,t._mouseDragCallback),e.addEventListener(X.MOUSE_MOVE,t._mouseDragCallback),e.addEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.addEventListener(X.TOUCH_END,t._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,t._mouseDragCallback)})),a(hn(t),"_deactivateDraw",(function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,t._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,t._mouseDragCallback),e.removeEventListener(X.MOUSE_MOVE,t._mouseDragCallback),e.removeEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.removeEventListener(X.TOUCH_END,t._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,t._mouseDragCallback)})),a(hn(t),"_activateModify",(function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,t._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,t._mouseDragCallback),e.addEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.addEventListener(X.TOUCH_END,t._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,t._mouseDragCallback)})),a(hn(t),"_deactivateModify",(function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,t._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,t._mouseDragCallback),e.removeEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.removeEventListener(X.TOUCH_END,t._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,t._mouseDragCallback)})),a(hn(t),"filterInteractableToolStateForElement",(function(e,t){if(t&&t.length){var n=(0,s.getEnabledElement)(e),a=n.viewport,o=n.scene,r=a.getCamera();return j(t,r,H(o,r).spacingInNormalDirection)}})),a(hn(t),"_findTextBoxAnchorPoints",(function(e){var n=t._getRectangleImageCoordinates(e),a=n.left,o=n.top,r=n.width,i=n.height;return[[a+r/2,o],[a,o+i/2],[a+r/2,o+i],[a+r,o+i/2]]})),a(hn(t),"_getRectangleImageCoordinates",(function(e){var t=T(e,2),n=t[0],a=t[1];return{left:Math.min(n[0],a[0]),top:Math.min(n[1],a[1]),width:Math.abs(n[0]-a[0]),height:Math.abs(n[1]-a[1])}})),a(hn(t),"_getTextLines",(function(e,t){var n=e.cachedStats[t],a=n.area,o=n.mean,r=n.stdDev,i=n.Modality;if(void 0!==o){var l=[],c="Area: ".concat(a.toFixed(2)," mm").concat(String.fromCharCode(178)),s="Mean: ".concat(o.toFixed(2)),d="Std Dev: ".concat(r.toFixed(2));return"PT"===i?(s+=" SUV",d+=" SUV"):"CT"===i?(s+=" HU",d+=" HU"):(s+=" MO",d+=" MO"),l.push(c),l.push(s),l.push(d),l}})),a(hn(t),"_calculateCachedStats",(function(e,n,a){for(var o=e.handles.points[0],r=e.handles.points[3],i=e.cachedStats,l=Object.keys(i),c=0;c<l.length;c++){var d=l[c],u=(0,s.getVolume)(d),v=u.dimensions,f=u.scalarData,h=u.vtkImageData,g=u.metadata,m=N.vec3.fromValues(0,0,0),p=N.vec3.fromValues(0,0,0);if(h.worldToIndexVec3(o,m),m[0]=Math.floor(m[0]),m[1]=Math.floor(m[1]),m[2]=Math.floor(m[2]),h.worldToIndexVec3(r,p),p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]),t._isInsideVolume(m,p,v)){for(var b=Math.min(m[0],p[0]),w=Math.max(m[0],p[0]),E=Math.min(m[1],p[1]),_=Math.max(m[1],p[1]),D=Math.min(m[2],p[2]),y=Math.max(m[2],p[2]),C=F(n,a,u,o,r),T=C.worldWidth*C.worldHeight,U=0,I=0,S=0,M=v[0],k=v[0]*v[1],x=D;x<=y;x++)for(var O=E;O<=_;O++)for(var L=b;L<=w;L++)U++,I+=f[x*k+O*M+L];I/=U;for(var R=D;R<=y;R++)for(var A=E;A<=_;A++)for(var P=b;P<=w;P++){var V=f[R*k+A*M+P]-I;S+=V*V}S/=U,S=Math.sqrt(S),i[d]={Modality:g.Modality,area:T,mean:I,stdDev:S}}else i[d]={Modality:g.Modality}}return e.invalidated=!1,i})),a(hn(t),"_isInsideVolume",(function(e,t,n){return St(e,n)&&St(t,n)})),a(hn(t),"_getTargetVolumeUID",(function(e){if(t.configuration.volumeUID)return t.configuration.volumeUID;var n=e.getVolumeActors();return n||n.length?n[0].uid:void 0})),t._throttledCalculateCachedStats=Gt(t._calculateCachedStats,100,{trailing:!0}),t}return n(l,[{key:"renderToolData",value:function(e,t){var n=e.detail.canvas,a=Kt(t.enabledElement,this.name);if(a&&(a=this.filterInteractableToolStateForElement(n,a)).length)for(var o=t.enabledElement,r=o.viewport,i=o.scene,l=this._getTargetVolumeUID(i),c=(D.getToolWidth(),0);c<a.length;c++){var s=a[c],d=s.metadata.toolUID,u=s.data,v=w.getColorIfActive(u),f=u.handles,h=f.points,g=f.activeHandleIndex,m=h.map((function(e){return r.worldToCanvas(e)}));if(u.cachedStats[l]){if(u.invalidated){var p=r.getCamera(),b=p.viewPlaneNormal,E=p.viewUp;this._throttledCalculateCachedStats(u,b,E)}}else{u.cachedStats[l]={};var _=r.getCamera(),y=_.viewPlaneNormal,C=_.viewUp;this._calculateCachedStats(u,y,C)}var T=void 0;this.editData||null===g||(T=[m[g]]),T&&Me(t,this.name,d,"0",T,{color:v}),Ve(t,this.name,d,"0",m[0],m[3],{color:v});var U=this._getTextLines(u,l);if(U&&0!==U.length){if(!u.handles.textBox.hasMoved){var I=Mt(m);u.handles.textBox.worldPosition=r.canvasToWorld(I)}var S=r.worldToCanvas(u.handles.textBox.worldPosition),M=Pe(t,this.name,d,"1",U,S,m,{},{color:v}),k=M.x,x=M.y,O=M.width,L=M.height;u.handles.textBox.worldBoundingBox={topLeft:r.canvasToWorld([k,x]),topRight:r.canvasToWorld([k+O,x]),bottomLeft:r.canvasToWorld([k,x+L]),bottomRight:r.canvasToWorld([k+O,x+L])}}}}}]),l}(wn);var Kn=function(t){mn(l,t);var o,r,i=(o=l,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,t=bn(o);if(r){var n=bn(this).constructor;e=Reflect.construct(t,arguments,n)}else e=t.apply(this,arguments);return pn(this,e)});function l(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e(this,l),a(hn(t=i.call(this,n,{name:"EllipticalRoi",supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0}})),"touchDragCallback",void 0),a(hn(t),"mouseDragCallback",void 0),a(hn(t),"_throttledCalculateCachedStats",void 0),a(hn(t),"editData",void 0),a(hn(t),"_configuration",void 0),a(hn(t),"addNewMeasurement",(function(e,n){var a=e.detail,o=a.currentPoints,r=a.element,i=o.world,l=o.canvas,c=(0,s.getEnabledElement)(r),d=c.viewport,u=c.FrameOfReferenceUID,v=c.renderingEngine;if(u){var f=d.getCamera(),h=f.viewPlaneNormal,g=f.viewUp,m={metadata:{viewPlaneNormal:U(h),viewUp:U(g),FrameOfReferenceUID:u,toolName:t.name},data:{invalidated:!0,handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0]},points:[U(i),U(i),U(i),U(i)],activeHandleIndex:null},isDrawing:!0,cachedStats:{},active:!0}};Yt(0,m);var p=It(r,t.name);t.editData={toolData:m,viewportUIDsToRender:p,centerCanvas:l,newAnnotation:!0,hasMoved:!1},t._activateDraw(r),xn(r),e.preventDefault(),v.renderViewports(p)}else console.warn("No FrameOfReferenceUID, empty scene, exiting early.")})),a(hn(t),"getHandleNearImagePoint",(function(e,t,n,a){var o=(0,s.getEnabledElement)(e).viewport,r=t.data,i=r.handles,l=i.points,c=i.textBox,d=c.worldBoundingBox;if(d){var u={topLeft:o.worldToCanvas(d.topLeft),topRight:o.worldToCanvas(d.topRight),bottomLeft:o.worldToCanvas(d.bottomLeft),bottmRight:o.worldToCanvas(d.bottomRight)};if(n[0]>=u.topLeft[0]&&n[0]<=u.bottmRight[0]&&n[1]>=u.topLeft[1]&&n[1]<=u.bottmRight[1])return r.handles.activeHandleIndex=null,c}for(var v=0;v<l.length;v++){var f=l[v],h=o.worldToCanvas(f);if(!0==N.vec2.distance(n,h)<a)return r.handles.activeHandleIndex=v,f}r.handles.activeHandleIndex=null})),a(hn(t),"pointNearTool",(function(e,n,a,o){var r=(0,s.getEnabledElement)(e).viewport,i=n.data.handles.points.map((function(e){return r.worldToCanvas(e)})),l=T(t._getCanvasEllipseCorners(i),2),c=l[0],d=l[1],u={left:Math.min(c[0],d[0])+o/2,top:Math.min(c[1],d[1])+o/2,width:Math.abs(c[0]-d[0])-o,height:Math.abs(c[1]-d[1])-o},v={left:Math.min(c[0],d[0])-o/2,top:Math.min(c[1],d[1])-o/2,width:Math.abs(c[0]-d[0])+o,height:Math.abs(c[1]-d[1])+o},f=x(u,a);if(x(v,a)&&!f)return!0})),a(hn(t),"toolSelectedCallback",(function(e,n){var a=e.detail.element;n.data.active=!0;var o=It(a,t.name);t.editData={toolData:n,viewportUIDsToRender:o,movingTextBox:!1},xn(a),t._activateModify(a),(0,s.getEnabledElement)(a).renderingEngine.renderViewports(o),e.preventDefault()})),a(hn(t),"handleSelectedCallback",(function(e,n,a){var o=e.detail.element,r=n.data;r.active=!0;var i,l,c,d,u,v=!1;if(a.worldPosition)v=!0;else{var f=r.handles.points,h=(0,s.getEnabledElement)(o).viewport.worldToCanvas;i=f.findIndex((function(e){return e===a}));var g=f.map(h);u=g[i],c=Math.abs(g[2][0]-g[3][0]),d=Math.abs(g[0][1]-g[1][1]),l=[(g[2][0]+g[3][0])/2,(g[0][1]+g[1][1])/2]}var m=It(o,t.name);t.editData={toolData:n,viewportUIDsToRender:m,handleIndex:i,canvasWidth:c,canvasHeight:d,centerCanvas:l,originalHandleCanvas:u,movingTextBox:v},t._activateModify(o),xn(o),(0,s.getEnabledElement)(o).renderingEngine.renderViewports(m),e.preventDefault()})),a(hn(t),"_mouseUpCallback",(function(e){var n=e.detail.element,a=t.editData,o=a.toolData,r=a.viewportUIDsToRender,i=a.newAnnotation,l=a.hasMoved,c=o.data;if(!i||l){c.active=!1,c.handles.activeHandleIndex=null,delete c.isDrawing,delete c.isDrawing,t._deactivateModify(n),t._deactivateDraw(n),kn(n);var d=(0,s.getEnabledElement)(n).renderingEngine;t.editData=null,d.renderViewports(r)}})),a(hn(t),"_mouseDragDrawCallback",(function(e){var n=e.detail,a=n.element,o=n.currentPoints.canvas,r=(0,s.getEnabledElement)(a),i=r.renderingEngine,l=r.viewport.canvasToWorld,c=t.editData,d=c.toolData,u=c.viewportUIDsToRender,v=c.centerCanvas,f=d.data,h=Math.abs(o[0]-v[0]),g=Math.abs(o[1]-v[1]),m=[v[0],v[1]-g],p=[v[0],v[1]+g],b=[v[0]-h,v[1]],w=[v[0]+h,v[1]];f.handles.points=[l(m),l(p),l(b),l(w)],f.invalidated=!0,t.editData.hasMoved=!0,i.renderViewports(u)})),a(hn(t),"_mouseDragModifyCallback",(function(e){var n=e.detail,a=n.element,o=t.editData,r=o.toolData,i=o.viewportUIDsToRender,l=o.handleIndex,c=o.movingTextBox,d=r.data;if(c){var u=n.deltaPoints.world,v=d.handles.textBox,f=v.worldPosition;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],v.hasMoved=!0}else if(void 0===l){var h=n.deltaPoints.world;d.handles.points.forEach((function(e){e[0]+=h[0],e[1]+=h[1],e[2]+=h[2]}))}else t._dragHandle(e);d.invalidated=!0,(0,s.getEnabledElement)(a).renderingEngine.renderViewports(i)})),a(hn(t),"_dragHandle",(function(e){var n=e.detail,a=n.element,o=(0,s.getEnabledElement)(a).viewport.canvasToWorld,r=t.editData,i=r.toolData,l=r.canvasWidth,c=r.canvasHeight,d=r.handleIndex,u=r.centerCanvas,v=r.originalHandleCanvas,f=i.data.handles.points,h=n.currentPoints.canvas;if(0===d||1===d){var g=Math.abs(h[1]-u[1]),m=[u[0],u[1]-g],p=[u[0],u[1]+g];f[0]=o(m),f[1]=o(p);var b=l/2+(h[0]-v[0]),w=[u[0]-b,u[1]],E=[u[0]+b,u[1]];f[2]=o(w),f[3]=o(E)}else{var _=Math.abs(h[0]-u[0]),D=[u[0]-_,u[1]],y=[u[0]+_,u[1]];f[2]=o(D),f[3]=o(y);var C=c/2+(h[1]-v[1]),T=[u[0],u[1]-C],U=[u[0],u[1]+C];f[0]=o(T),f[1]=o(U)}})),a(hn(t),"_activateModify",(function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,t._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,t._mouseDragModifyCallback),e.addEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.addEventListener(X.TOUCH_END,t._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,t._mouseDragModifyCallback)})),a(hn(t),"_deactivateModify",(function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,t._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,t._mouseDragModifyCallback),e.removeEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.removeEventListener(X.TOUCH_END,t._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,t._mouseDragModifyCallback)})),a(hn(t),"_activateDraw",(function(e){Dt.isToolLocked=!0,e.addEventListener(X.MOUSE_UP,t._mouseUpCallback),e.addEventListener(X.MOUSE_DRAG,t._mouseDragDrawCallback),e.addEventListener(X.MOUSE_MOVE,t._mouseDragDrawCallback),e.addEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.addEventListener(X.TOUCH_END,t._mouseUpCallback),e.addEventListener(X.TOUCH_DRAG,t._mouseDragDrawCallback)})),a(hn(t),"_deactivateDraw",(function(e){Dt.isToolLocked=!1,e.removeEventListener(X.MOUSE_UP,t._mouseUpCallback),e.removeEventListener(X.MOUSE_DRAG,t._mouseDragDrawCallback),e.removeEventListener(X.MOUSE_MOVE,t._mouseDragDrawCallback),e.removeEventListener(X.MOUSE_CLICK,t._mouseUpCallback),e.removeEventListener(X.TOUCH_END,t._mouseUpCallback),e.removeEventListener(X.TOUCH_DRAG,t._mouseDragDrawCallback)})),a(hn(t),"filterInteractableToolStateForElement",(function(e,t){if(t&&t.length){var n=(0,s.getEnabledElement)(e),a=n.viewport,o=n.scene,r=a.getCamera();return j(t,r,H(o,r).spacingInNormalDirection)}})),a(hn(t),"_getCanvasEllipseCorners",(function(e){var t=T(e,4),n=t[0],a=t[1],o=t[2],r=t[3];return[[o[0],a[1]],[r[0],n[1]]]})),a(hn(t),"_getTextLines",(function(e,t){var n=e.cachedStats[t],a=n.area,o=n.mean,r=n.stdDev,i=n.isEmptyArea,l=n.Modality;if(void 0!==o){var c=[],s=i?"Area: Oblique not supported":"Area: ".concat(a.toFixed(2)," mm").concat(String.fromCharCode(178)),d="Mean: ".concat(o.toFixed(2)),u="Std Dev: ".concat(r.toFixed(2));return"PT"===l?(d+=" SUV",u+=" SUV"):"CT"===l?(d+=" HU",u+=" HU"):(d+=" MO",u+=" MO"),c.push(s),c.push(d),c.push(u),c}})),a(hn(t),"_calculateCachedStats",(function(e,n,a){for(var o=T(a,2),r=o[0],i=o[1],l=n.canvasToWorld(r),c=n.canvasToWorld(i),d=n.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=e.cachedStats,h={left:Math.min(r[0],i[0]),top:Math.min(r[1],i[1]),width:Math.abs(r[0]-i[0]),height:Math.abs(r[1]-i[1])},g=Object.keys(f),m=0;m<g.length;m++){var p=g[m],b=(0,s.getVolume)(p),w=b.dimensions,E=b.scalarData,_=b.vtkImageData,D=b.metadata,y=N.vec3.fromValues(0,0,0),C=N.vec3.fromValues(0,0,0);if(_.worldToIndexVec3(l,y),y[0]=Math.floor(y[0]),y[1]=Math.floor(y[1]),y[2]=Math.floor(y[2]),_.worldToIndexVec3(c,C),C[0]=Math.floor(C[0]),C[1]=Math.floor(C[1]),C[2]=Math.floor(C[2]),t._isInsideVolume(y,C,w)){var U=Math.min(y[0],C[0]),I=Math.max(y[0],C[0]),S=Math.min(y[1],C[1]),M=Math.max(y[1],C[1]),k=Math.min(y[2],C[2]),O=Math.max(y[2],C[2]),L=F(u,v,b,l,c),R=L.worldWidth,A=L.worldHeight,P=0===R&&0===A,V=Math.PI*(R/2)*(A/2),B=0,H=0,j=0,W=w[0],G=w[0]*w[1],z=N.vec3.fromValues(U,S,k),q=N.vec3.create();_.indexToWorldVec3(z,q);var K=n.worldToCanvas(q),Y=N.vec3.fromValues(U+1,S,k),X=N.vec3.fromValues(U,S+1,k),$=N.vec3.fromValues(U,S,k+1),J=N.vec3.create(),Z=N.vec2.create();_.indexToWorldVec3(Y,J);var Q=n.worldToCanvas(J);N.vec2.sub(Z,Q,K);var ee=N.vec3.create(),te=N.vec2.create();_.indexToWorldVec3(X,ee);var ne=n.worldToCanvas(ee);N.vec2.sub(te,ne,K);var ae=N.vec3.create(),oe=N.vec2.create();_.indexToWorldVec3($,ae);var re=n.worldToCanvas(ae);N.vec2.sub(oe,re,K);for(var ie=k;ie<=O;ie++)for(var le=S;le<=M;le++)for(var ce=U;ce<=I;ce++){var se=ce-U,de=le-S,ue=ie-k,ve=[K[0],K[1]];x(h,ve=[ve[0]+Z[0]*se+te[0]*de+oe[0]*ue,ve[1]+Z[1]*se+te[1]*de+oe[1]*ue])&&(B++,H+=E[ie*G+le*W+ce])}H/=B;for(var fe=k;fe<=O;fe++)for(var he=S;he<=M;he++)for(var ge=U;ge<=I;ge++){var me=E[fe*G+he*W+ge]-H;j+=me*me}j/=B,j=Math.sqrt(j),f[p]={Modality:D.Modality,area:V,mean:H,stdDev:j,isEmptyArea:P}}else f[p]={Modality:D.Modality}}return e.invalidated=!1,f})),a(hn(t),"_isInsideVolume",(function(e,t,n){return St(e,n)&&St(t,n)})),a(hn(t),"_getTargetVolumeUID",(function(e){if(t.configuration.volumeUID)return t.configuration.volumeUID;var n=e.getVolumeActors();return n||n.length?n[0].uid:void 0})),t._throttledCalculateCachedStats=Gt(t._calculateCachedStats,100,{trailing:!0}),t}return n(l,[{key:"renderToolData",value:function(e,t){var n=e.detail.canvas,a=Kt(t.enabledElement,this.name);if(a&&(a=this.filterInteractableToolStateForElement(n,a)).length)for(var o=t.enabledElement,r=o.viewport,i=o.scene,l=this._getTargetVolumeUID(i),c=(D.getToolWidth(),0);c<a.length;c++){var s=a[c],d=s.metadata.toolUID,u=s.data,v=w.getColorIfActive(u),f=u.handles,h=u.isDrawing,g=f.points,m=f.activeHandleIndex,p=g.map((function(e){return r.worldToCanvas(e)})),b=this._getCanvasEllipseCorners(p);u.cachedStats[l]?u.invalidated&&this._throttledCalculateCachedStats(u,r,b):(u.cachedStats[l]={},this._calculateCachedStats(u,r,b));var E=void 0;this.editData||null===m||(E=[p[m]]),E&&Me(t,this.name,d,"0",E,{color:v}),Se(t,this.name,d,"0",b[0],b[1],{color:v});var _=this._getTextLines(u,l);if(_&&0!==_.length&&!h){var y=void 0;u.handles.textBox.hasMoved||(y=Mt(b),u.handles.textBox.worldPosition=r.canvasToWorld(y));var C=r.worldToCanvas(u.handles.textBox.worldPosition),T=Pe(t,this.name,d,"1",_,C,p,{},{color:v}),U=T.x,I=T.y,S=T.width,M=T.height;u.handles.textBox.worldBoundingBox={topLeft:r.canvasToWorld([U,I]),topRight:r.canvasToWorld([U+S,I]),bottomLeft:r.canvasToWorld([U,I+M]),bottomRight:r.canvasToWorld([U+S,I+M])}}}}}]),l}(wn)}(),c}()}));
//# sourceMappingURL=index.js.map